<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Guild War Defense Data</title>
  <style>
    :root {
      --bg: #0f0f1a;
      --panel-bg: #1a1a2a;
      --border: #333;
      --text: #e0e0e0;
      --text-light: #aaa;
      --accent: #ffd700;
      --btn-bg: #2a3a5a;
      --btn-hover: #3a4a7a;
      --error-bg: #442222;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 0;
      line-height: 1;
      overflow-x: hidden;
    }

    .header {
      text-align: center;
      margin: 16px 0;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
      color: var(--accent);
      font-weight: 700;
      text-shadow: 0 0 6px rgba(255, 215, 0, 0.5);
    }

    /* === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ø–∞–Ω–µ–ª–∏ —Å–≤–µ—Ä—Ö—É) === */
    .controls-row {
      display: flex;
      gap: 20px;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 16px;
      flex-wrap: wrap;
	  align-items: flex-start;
    }

    .panel {
      background: var(--panel-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      flex: 1;
      min-width: 300px;
    }

    .panel-header {
      padding: 8px 12px;
      background: rgba(30, 30, 45, 0.8);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 12px;
      color: var(--accent);
      border-bottom: 1px solid var(--border);
    }
    .panel-header::before {
      content: "";
      width: 16px;
      height: 16px;
      background-size: contain;
      background-repeat: no-repeat;
    }
    .panel-header.online::before {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffd700"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>');
    }
    .panel-header.file::before {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffd700"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 16H8v-2h8v2zm-2-4H8v-2h8v2zm-2-5H8V7h8v2z"/></svg>');
    }

    .panel-body {
      padding: 8px;
    }

    .form-group {
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      color: var(--text-light);
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 6px 8px;
      background: #222;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
    }
    .form-group input[type="password"] {
      font-family: monospace;
    }

    .btn {
      width: 100%;
      padding: 8px 12px;
      background: var(--btn-bg);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }
    .btn:hover {
      background: var(--btn-hover);
    }
    .btn-primary {
      background: #4a90e2;
    }
    .btn-primary:hover {
      background: #357abd;
    }

    /* === –û—à–∏–±–∫–∏ === */
    .error-box {
      background: var(--error-bg);
      padding: 14px;
      border-radius: 6px;
      margin: 16px auto;
      max-width: 1600px;
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 14px;
      display: none;
      width: calc(100% - 32px);
      padding-left: 16px;
      padding-right: 16px;
    }

    /* === –¢–∞–±–ª–∏—Ü—ã ‚Äî –ü–û–õ–ù–ê–Ø –®–ò–†–ò–ù–ê, –ë–ï–ó –û–¢–°–¢–£–ü–û–í === */
    .tables-fullwidth {
      width: 100%;
      padding: 0 16px;
      box-sizing: border-box;
    }

    .table-wrapper {
      margin: 16px 0;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü ‚Äî –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–∞–º–∏, –±–µ–∑ –æ–±—ë—Ä—Ç–∫–∏ */
    .table-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--accent);
      text-align: center;
      margin: 20px 0 12px;
      text-shadow: 0 0 4px rgba(255,215,0,0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: fixed;
      overflow-x: auto;
      display: block;
      white-space: nowrap;
    }
    /* === –ó–ê–ì–û–õ–û–í–ö–ò –°–¢–û–õ–ë–¶–û–í –¢–ê–ë–õ–ò–¶–´ === */
	.table-header-row th {
	  background: rgba(30, 30, 45, 0.8);
	  font-weight: 600;
	  color: var(--accent);
	  border: 1px solid var(--border);
	  padding: 6px 8px;        /* –º–µ–Ω—å—à–µ padding ‚Üí –Ω–∏–∂–µ –≤—ã—Å–æ—Ç–∞ */
	  text-align: center;
	  font-size: 12px;         /* —á—É—Ç—å –º–µ–ª—å—á–µ */
	  height: auto;            /* –Ω–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Å–æ—Ç—É */
	  vertical-align: middle;
	}

	/* === –°–¢–†–û–ö–ò –î–ê–ù–ù–´–• –¢–ê–ë–õ–ò–¶–´ === */
	.table-body-rows td {
	  border: 1px solid var(--border);
	  padding: 8px 8px;
	  vertical-align: top;
	  height: 120px;           /* –æ—Å—Ç–∞–≤–∏—Ç—å –≤—ã—Å–æ–∫–∏–º–∏ –¥–ª—è —Ç—Ä–æ–æ–ø–æ–≤ */
	  display: table-cell;
	  line-height: 1.2;
	  font-size: 13px;
	}
    .col-name    { 
	  width: 20%; 
	  white-space: normal;
	}
    .col-level   { width: 8%; }
    .col-troops  { width: 40%; }
    .col-banner  { 
	  width: 22%;
	  vertical-align: center;
	  }
    .col-class   { width: 22%; }

    .section-header {
      background: rgba(30, 30, 45, 0.8);
      padding: 4px 10px;  
      border-radius: 4px;
      font-weight: 600;
      color: var(--accent);
      margin: 16px 0 8px;
	  width: 30%; 
      font-size: 16px;
    }

    /* === –¢—Ä–æ–æ–ø—ã –∏ –∏–∫–æ–Ω–∫–∏ === */
    .troop-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 2px 0;
    }
    .cw-svg {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    .cw-svg svg {
      width: 100%;
      height: 100%;
    }

    .banner-icon, .class-icon {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .banner-icon img,
    .class-icon img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      border-radius: 4px;
      background: #222;
      border: 1px solid var(--border);
    }

    /* === –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî –ø–∞–Ω–µ–ª–∏ —Å—Ç–µ–∫–∞—é—Ç—Å—è, —Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞—é—Ç—Å—è full-width */
    @media (max-width: 900px) {
      .controls-row {
        flex-direction: column;
      }
      .tables-fullwidth {
        padding: 0;
      }
    }
	/* === –î–í–£–•–ö–û–õ–û–ù–û–ß–ù–´–ô –ë–õ–û–ö –¢–ê–ë–õ–ò–¶ === */
	.tables-flex-container {
	  display: flex;
	  gap: 24px;
	  padding: 0 16px;
	  margin-top: 16px;
	  overflow-x: auto;
	  width: 100%;
	  box-sizing: border-box;
	}

	.table-column {
	  flex: 1;
	  min-width: 0; /* –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
	}

	.table-column > h2.table-title {
	  margin: 0 0 8px 0;
	  font-size: 22px;
	}

	/* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: —Å—Ç–µ–∫–∞–µ–º –≤ –∫–æ–ª–æ–Ω–∫—É */
	@media (max-width: 900px) {
	  .tables-flex-container {
		flex-direction: column;
	  }
	}
	/* === –î–í–£–•–ö–û–õ–û–ù–û–ß–ù–ê–Ø –§–û–†–ú–ê –í–ù–£–¢–†–ò –ü–ê–ù–ï–õ–ò === */
	.form-grid {
	  display: flex;
	  gap: 12px;
	}

	.form-col {
	  flex: 1;
	  min-width: 0;
	}

    .form-grid-three {
      display: flex;
      gap: 12px;
    }
    
    .form-col-three {
      flex: 1;
      min-width: 0;
    }
    
    /* –°—Ç–∏–ª—å –¥–ª—è —Å—Å—ã–ª–∫–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π */
    .help-link {
      font-size: 11px;
      color: #4a90e2;
      text-decoration: none;
      margin-top: 4px;
      display: inline-block;
    }
    
    .help-link:hover {
      text-decoration: underline;
      color: #5aa0f2;
    }
    
    /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ (tooltip) */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 420px;
      background-color: #2a2a3a;
      color: #e0e0e0;
      text-align: center;
      border-radius: 6px;
      padding: 6px;
      position: absolute;
      z-index: 1;
	  /* top: 0%; */
      left: 50%;
      bottom: 125%;
      left: 50%;
      margin-left: -150px;
      opacity: 1;
      transition: opacity 0.3s;
      border: 1px solid #444;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      font-size: 12px;
      line-height: 1.4;
      white-space: normal;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Ç—Ä–µ—Ö–∫–æ–ª–æ–Ω–æ—á–Ω–æ–π —Ñ–æ—Ä–º—ã */
    @media (max-width: 768px) {
      .form-grid-three {
        flex-direction: column;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ —Å–æ–±—ã—Ç–∏—è */
    #eventIdError {
      color: #ff6b6b;
      margin-top: 4px;
      font-size: 12px;
      display: none;
    }
    
    .event-select-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .event-description {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 4px;
      line-height: 1.3;
    }
    
    .loading-events {
      color: var(--text-light);
      font-style: italic;
      font-size: 12px;
      text-align: center;
      padding: 4px 0;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>Guild War Defense Data</h1>
</div>

<div id="errorBox" class="error-box"></div>

<!-- === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –æ–Ω–ª–∞–π–Ω + —Ñ–∞–π–ª (–≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É) === -->
<div class="controls-row">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –û–Ω–ª–∞–π–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <div class="panel">
    <div class="panel-header online">–û–Ω–ª–∞–π–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
    <div class="panel-body">
      <form id="onlineForm">
        <div class="form-grid-three">
          <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: Invite Code –∏ Password -->
          <div class="form-col-three">
            <div class="form-group">
              <label for="inviteCode">Invite Code:</label>
              <input type="text" id="inviteCode" placeholder="" autocomplete="username" required>
            </div>
            <div class="form-group">
              <label for="password">Password:</label>
              <input type="password" id="password" placeholder="" autocomplete="current-password" required>
            </div>
          </div>

          <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: –í—ã–±–æ—Ä —Å–æ–±—ã—Ç–∏—è -->
          <div class="form-col-three">
            <div class="form-group">
              <label for="eventIdSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ –≤–æ–π–Ω—ã:</label>
              <div class="event-select-container">
                <select id="eventIdSelect" required>
                  <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π...</option>
                </select>
                <div id="eventIdError"></div>
                <div class="event-description">
                  –°–æ–±—ã—Ç–∏—è —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é –Ω–µ–¥–µ–ª—é –≤–æ–π–Ω—ã.
                </div>
              </div>
            </div>
          </div>

          <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–µ–Ω—å –≤–æ–π–Ω—ã –∏ –∫–Ω–æ–ø–∫–∞ -->
          <div class="form-col-three">
            <div class="form-group">
              <label for="warDaySelect">–î–µ–Ω—å –≤–æ–π–Ω—ã:</label>
              <select id="warDaySelect">
                <option value="0">–ß–µ—Ç–≤–µ—Ä–≥</option>
                <option value="1">–ü—è—Ç–Ω–∏—Ü–∞</option>
                <option value="2">–°—É–±–±–æ—Ç–∞</option>
                <option value="3">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞ -->
  <div class="panel">
    <div class="panel-header file">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</div>
    <div class="panel-body">
      <div class="form-group">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ JSON-—Ñ–∞–π–ª:</label>
        <input type="file" id="jsonFile" accept=".json" style="display:none;">
        <div class="btn" onclick="document.getElementById('jsonFile').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</div>
        <div id="fileNameDisplay" style="margin-top: 8px; font-size: 13px; color: var(--text-light);">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
      </div>
      <button type="button" class="btn" onclick="loadJsonFromFile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
    </div>
  </div>
</div>

<!-- === –¢–ê–ë–õ–ò–¶–´ ‚Äî –ü–û–õ–ù–ê–Ø –®–ò–†–ò–ù–ê, –ë–ï–ó –û–¢–°–¢–£–ü–û–í === -->
<div class="tables-flex-container">
  <!-- –õ–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: –ú–æ—è –≥–∏–ª—å–¥–∏—è -->
  <div class="table-column">
    <h2 class="table-title" id="myTitle">–ú–æ—è –≥–∏–ª—å–¥–∏—è</h2>
    <div id="myKeep"></div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: –ì–∏–ª—å–¥–∏—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ -->
  <div class="table-column">
    <h2 class="table-title" id="oppTitle">–ì–∏–ª—å–¥–∏—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</h2>
    <div id="opponentKeep"></div>
  </div>
</div>

<script>
// =============== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===============
const LOCATION_NAMES = {
  'Rank1Loc1': '–°–≤—è—Ç–∏–ª–∏—â–µ',
  'Rank1Loc2': '–ü–æ–ª—è–Ω–∞',
  'Rank2Loc1': '–ü–æ—Ä—Ç–∞–ª',
  'Rank2Loc2': '–ò–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å –ª—É–∫–æ–≤',
  'Rank2Loc3': '–ö—É—Ö–Ω—è',
  'Rank3Loc1': '–•—Ä–∞–º',
  'Rank3Loc2': '–ê–ø—Ç–µ–∫–∞—Ä—å',
  'Rank3Loc3': '–õ–∞–±–∏—Ä–∏–Ω—Ç',
  'Palace': '–î–≤–æ—Ä–µ—Ü'
};

const LOCATION_ORDER = [
  'Rank1Loc1', 'Rank1Loc2', 'Rank2Loc1', 'Rank2Loc2', 'Rank2Loc3',
  'Rank3Loc1', 'Rank3Loc2', 'Rank3Loc3', 'Palace'
];

const COLORS = {
  brown: '#8B4513', purple: '#800080', yellow: '#FFD700',
  red: '#FF0000', green: '#00FF00', blue: '#0000FF'
};
const COLOR_MASKS = {
  brown: 1, purple: 4, yellow: 16, red: 64, green: 256, blue: 1024
};

function getActiveColors(colorNumber) {
  const res = [];
  for (const [name, mask] of Object.entries(COLOR_MASKS)) {
    if (colorNumber & mask) res.push({ name, color: COLORS[name] });
  }
  return res;
}

function createColorWheelSVG(activeColors) {
  const div = document.createElement('div');
  div.className = 'cw-svg';
  if (!activeColors || activeColors.length === 0) {
    div.innerHTML = '<svg width="24" height="24" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#222"/></svg>';
    return div;
  }
  if (activeColors.length === 1) {
    const c = activeColors[0];
    div.innerHTML = `<svg width="24" height="24" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="${c.color}"/></svg>`;
    return div;
  }
  const sorted = ['brown','purple','yellow','red','green','blue']
    .map(n => activeColors.find(c => c.name === n)).filter(Boolean);
  const r = 45, cx = 50, cy = 50, seg = 360 / sorted.length;
  let paths = '';
  for (let i = 0; i < sorted.length; i++) {
    const a1 = i * seg - 90, a2 = (i+1) * seg - 90;
    const x1 = cx + r * Math.cos(a1 * Math.PI/180);
    const y1 = cy + r * Math.sin(a1 * Math.PI/180);
    const x2 = cx + r * Math.cos(a2 * Math.PI/180);
    const y2 = cy + r * Math.sin(a2 * Math.PI/180);
    const la = seg > 180 ? 1 : 0;
    const d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${la} 1 ${x2} ${y2} Z`;
    paths += `<path d="${d}" fill="${sorted[i].color}"/>`;
  }
  div.innerHTML = `<svg width="24" height="24" viewBox="0 0 100 100">${paths}</svg>`;
  return div;
}

// =============== –ö—ç—à–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ ===============
let weaponsCache = null, troopsCache = null, kingdomsCache = null, classesCache = null;
const DATA_DIR = 'gems_of_war_data';

async function loadJSON(filename) {
  try {
    const res = await fetch(`${DATA_DIR}/${filename}`);
    if (!res.ok) throw '';
    return await res.json();
  } catch {
    const res = await fetch(filename);
    if (!res.ok) throw new Error(`–ù–µ –Ω–∞–π–¥–µ–Ω ${filename}`);
    return await res.json();
  }
}

async function ensureLoaded() {
  if (!weaponsCache || !troopsCache || !kingdomsCache || !classesCache) {
    const [w, t, k, c] = await Promise.all([
      loadJSON('Weapons_Russian.json'),
      loadJSON('Troops_Russian.json'),
      loadJSON('Kingdoms_Russian.json'),
      loadJSON('ClassesDetails_Russian.json')
    ]);
    weaponsCache = w.weapons || w;
    troopsCache = t.troops || t;
    kingdomsCache = k.kingdoms || k;
    classesCache = c.classes || c;
  }
}

function getItemName(id) {
  if (id >= 1000 && id <= 1999) {
    const w = weaponsCache?.find(x => x.id == id);
    return w ? w.name : `W:${id}`;
  }
  if (id >= 6000 && id <= 7999) {
    const t = troopsCache?.find(x => x.id == id);
    return t ? t.name : `T:${id}`;
  }
  return `ID:${id}`;
}

function getItemColors(id) {
  if (id >= 1000 && id <= 1999) {
    const w = weaponsCache?.find(x => x.id == id);
    return w ? w.colors || 0 : 0;
  }
  if (id >= 6000 && id <= 7999) {
    const t = troopsCache?.find(x => x.id == id);
    return t ? t.colors || 0 : 0;
  }
  return 0;
}

function getBannerInfo(bannerId) {
  const k = kingdomsCache?.find(x => x.id == bannerId);
  return {
    name: k?.bannerName || `–§–ª–∞–≥ ${bannerId}`,
    img: k?.bannerImageUrl ? `${DATA_DIR}/banners/${k.bannerImageUrl}` : null
  };
}

function getClassInfo(classCode) {
  if (!classCode) return { name: '‚Äî', img: null };
  const cls = classesCache?.find(c => c.classCode === classCode);
  return {
    name: cls?.name || classCode,
    img: cls?.imageUrl ? `${DATA_DIR}/classes/${cls.imageUrl}` : null
  };
}

// =============== –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü ===============
function renderGuildSection(containerId, data, titleElId, defaultTitle) {
  const container = document.getElementById(containerId);
  const titleEl = document.getElementById(titleElId);
  titleEl.textContent = titleElId === 'myTitle' ? '–ú–æ—è –≥–∏–ª—å–¥–∏—è' : defaultTitle;

  container.innerHTML = '';

  if (!data?.DefenceData) {
    container.innerHTML = '<p style="text-align:center; padding:24px; color:#aaa;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
    return;
  }

  for (const locKey of LOCATION_ORDER) {
    const locData = data.DefenceData[locKey];
    if (!locData || !Array.isArray(locData.Defenders)) continue;

    const defenders = locData.Defenders;
    const rows = [...defenders];
    while (rows.length < 3) rows.push(null);
    rows.length = 3;

    const sectionName = LOCATION_NAMES[locKey] || locKey;
    const header = document.createElement('div');
    header.className = 'section-header';
    header.textContent = sectionName;
    container.appendChild(header);

	const tbl = document.createElement('table');
	tbl.innerHTML = `
	  <thead class="table-header-row">
		<tr>
		  <th class="col-name">Name</th>
		  <th class="col-level">Level</th>
		  <th class="col-troops">Troops</th>
		  <th class="col-banner">Banner</th>
		  <th class="col-class">Class</th>
		</tr>
	  </thead>
	  <tbody class="table-body-rows"></tbody>
	`;
    const tbody = tbl.querySelector('tbody');

    for (const def of rows) {
      const tr = tbody.insertRow();

      const cells = [];
      for (let i = 0; i < 5; i++) {
        const cell = tr.insertCell();
        cells.push(cell);
        if (!def) {
          const filler = document.createElement('div');
          filler.style.height = '100%';
          filler.style.width = '100%';
          cell.appendChild(filler);
        }
      }

      if (!def) continue;

      cells[0].textContent = def.Name || '‚Äî';
      cells[1].textContent = def.Level || '‚Äî';

      // Troops
      const troopsCell = cells[2];
      const troopIds = def.DefenceTeam?.Troops || [];
      if (troopIds.length > 0) {
        const fragment = document.createDocumentFragment();
        for (const id of troopIds) {
          const rowDiv = document.createElement('div');
          rowDiv.className = 'troop-row';
          rowDiv.appendChild(createColorWheelSVG(getActiveColors(getItemColors(id))));
          rowDiv.appendChild(document.createTextNode(getItemName(id)));
          fragment.appendChild(rowDiv);
        }
        troopsCell.appendChild(fragment);
      } else {
        troopsCell.textContent = '‚Äî';
      }

      // Banner
      const bannerCell = cells[3];
      const bannerId = def.DefenceTeam?.Banner;
      if (bannerId) {
        const { name, img } = getBannerInfo(bannerId);
        const div = document.createElement('div');
        div.className = 'banner-icon';
        if (img) {
          const imgEl = document.createElement('img');
          imgEl.src = img;
          imgEl.alt = name;
          div.appendChild(imgEl);
        }
        div.appendChild(document.createTextNode(name));
        bannerCell.appendChild(div);
      } else {
        bannerCell.textContent = '‚Äî';
      }

      // Class
      const classCell = cells[4];
      const classCode = def.DefenceTeam?.Class;
      if (classCode) {
        const { name, img } = getClassInfo(classCode);
        const div = document.createElement('div');
        div.className = 'class-icon';
        if (img) {
          const imgEl = document.createElement('img');
          imgEl.src = img;
          imgEl.alt = name;
          div.appendChild(imgEl);
        }
        div.appendChild(document.createTextNode(name));
        classCell.appendChild(div);
      } else {
        classCell.textContent = '‚Äî';
      }
    }

    container.appendChild(tbl);
  }
}

// =============== –£—Ç–∏–ª–∏—Ç—ã ===
function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = msg;
  el.style.display = 'block';
}
function hideError() {
  document.getElementById('errorBox').style.display = 'none';
}

// =============== –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤–æ–π–Ω—ã ===============
function formatDate(date) {
  const d = String(date.getDate()).padStart(2, '0');
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const y = date.getFullYear();
 //return `${d}-${m}`;
  return `${d}.${m}.${y}`;
}

function showErrorEvents(message) {
  const errorEl = document.getElementById('eventIdError');
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  
  const select = document.getElementById('eventIdSelect');
  select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</option>';
}

async function loadEventsFile() {
  try {
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
    let response = await fetch(`${DATA_DIR}/LiveEvents_pcmob.txt`);
    if (!response.ok) {
      // –ü–æ–ø—Ä–æ–±—É–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π
      response = await fetch('https://garyatrics.com/taran-data/LiveEvents_pcmob.txt');
    }
    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π');
    
    const text = await response.text();
    parseEventsText(text);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
    showErrorEvents('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
  }
}

function parseEventsText(text) {
  const lines = text.split('\n').filter(line => line.trim() !== '');
  const events = [];
  const now = Date.now() / 1000; // —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

  for (const line of lines) {
    if (line.includes('~~0~~0')) {
      const parts = line.split('~~');
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–∞ –ø–æ–ª—è - –Ω—É–ª–∏
      if (parts.length >= 5 && parts[3] === '0' && parts[4].trim() === '0') {
        const startEpoch = parseInt(parts[0]);
        const endEpoch = parseInt(parts[1]);
        const eventId = parseInt(parts[2]);
        if (!isNaN(startEpoch) && !isNaN(endEpoch) && !isNaN(eventId)) {
          events.push({ start: startEpoch, end: endEpoch, eventId });
        }
      }
    }
  }

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞
  events.sort((a, b) => a.start - b.start);

  // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ (–≤ –∫–æ—Ç–æ—Ä–æ–º —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏–º—Å—è)
  let currentEventIndex = -1;
  for (let i = 0; i < events.length; i++) {
    if (now >= events[i].start && now <= events[i].end) {
      currentEventIndex = i;
      break;
    }
  }

  let selectedEvents = [];
  
  if (currentEventIndex !== -1) {
    // –ï—Å—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ - –±–µ—Ä–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ, —Ç–µ–∫—É—â–µ–µ –∏ —Å–ª–µ–¥—É—é—â–µ–µ
    if (currentEventIndex > 0) {
      selectedEvents.push(events[currentEventIndex - 1]);
    }
    selectedEvents.push(events[currentEventIndex]);
    if (currentEventIndex < events.length - 1) {
      selectedEvents.push(events[currentEventIndex + 1]);
    }
  } else {
    // –ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è - –∏—â–µ–º –±–ª–∏–∂–∞–π—à–µ–µ –ø—Ä–æ—à–ª–æ–µ –∏ –±—É–¥—É—â–µ–µ
    let lastPast = null;
    let nextFuture = null;
    
    // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–æ—à–µ–¥—à–µ–µ —Å–æ–±—ã—Ç–∏–µ
    for (let i = events.length - 1; i >= 0; i--) {
      if (events[i].end < now) {
        lastPast = events[i];
        break;
      }
    }
    
    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–µ–µ –±—É–¥—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ
    for (let i = 0; i < events.length; i++) {
      if (events[i].start > now) {
        nextFuture = events[i];
        break;
      }
    }
    
    if (lastPast) selectedEvents.push(lastPast);
    if (nextFuture) selectedEvents.push(nextFuture);
  }

  // –ó–∞–ø–æ–ª–Ω—è–µ–º select
  const select = document.getElementById('eventIdSelect');
  select.innerHTML = ''; // –æ—á–∏—â–∞–µ–º

  if (selectedEvents.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π';
    option.disabled = true;
    select.appendChild(option);
    showErrorEvents('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
    return;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ select
  selectedEvents.forEach(event => {
    const startDate = new Date(event.start * 1000);
    const endDate = new Date(event.end * 1000);
    //const label = `${formatDate(startDate)}-${formatDate(endDate)} (EventId: ${event.eventId})`;
	const label = `${formatDate(startDate)}-${formatDate(endDate)}`;
    const option = document.createElement('option');
    option.value = event.eventId;
    option.textContent = label;
    select.appendChild(option);
  });

  // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –±—ã–ª–∞
  document.getElementById('eventIdError').style.display = 'none';
}

// =============== –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∏ ===
document.getElementById('onlineForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  hideError();

  const inviteCode = document.getElementById('inviteCode').value.trim().toUpperCase();
  const password = document.getElementById('password').value;
  const warDay = parseInt(document.getElementById('warDaySelect').value, 10);
  const eventIdSelect = document.getElementById('eventIdSelect');
  const EventId = parseInt(eventIdSelect.value, 10);

  if (!inviteCode || !password) {
    showError('–í–≤–µ–¥–∏—Ç–µ Invite Code –∏ –ø–∞—Ä–æ–ª—å');
    return;
  }

  if (!eventIdSelect.value) {
    showError('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ –≤–æ–π–Ω—ã –∏–∑ —Å–ø–∏—Å–∫–∞');
    return;
  }

  if (isNaN(EventId) || EventId <= 0) {
    showError('–í—ã–±—Ä–∞–Ω–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤–æ–π–Ω—ã');
    return;
  }
  
  try {
    const apiUrl = "https://pcmob.parse.gemsofwar.com/call_function";

    // –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å username –ø–æ Invite Code
    const profileReq = { functionName: "get_hero_profile", NameCode: inviteCode };
    const profileResp = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(profileReq)
    });

    if (!profileResp.ok) {
      throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: ${profileResp.status} ${profileResp.statusText}`);
    }

    const profileJson = await profileResp.json();
    console.log('üîç –ü—Ä–æ—Ñ–∏–ª—å:', profileJson);

    const realUsername = profileJson?.result?.ProfileData?.username;
    if (!realUsername || realUsername === "null") {
      throw new Error('Invite Code –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.');
    }

    console.log(`üìÖ EventId: ${EventId}, WarDay: ${warDay}`);

    // –®–ê–ì 2: –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –≤–æ–π–Ω—ã
    const warReq = {
      functionName: "guild_wars_get_guild_keep_data",
      username: realUsername,
      password: password,
      EventId: EventId,
      WarDay: warDay,
      NumWars: 4
    };

    const warResp = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(warReq)
    });

    if (!warResp.ok) {
      const text = await warResp.text();
      throw new Error(`HTTP ${warResp.status}: ${text}`);
    }

    const warJson = await warResp.json();
    console.log('‚öîÔ∏è –û—Ç–≤–µ—Ç:', warJson);

    if (!warJson.result?.GuildKeepData) {
      if (warJson.error) throw new Error(warJson.error);
      throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª GuildKeepData. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å, –¥–µ–Ω—å –≤–æ–π–Ω—ã –∏–ª–∏ EventId.');
    }

    await ensureLoaded();

    const myData = warJson.result.GuildKeepData.MyKeepData;
    const oppData = warJson.result.GuildKeepData.OpponentKeepData;
    const oppName = oppData?.GuildData?.Name || '–ì–∏–ª—å–¥–∏—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';

    renderGuildSection('myKeep', myData, 'myTitle', '–ú–æ—è –≥–∏–ª—å–¥–∏—è');
    renderGuildSection('opponentKeep', oppData, 'oppTitle', oppName);

  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', err);
    showError('–û—à–∏–±–∫–∞:\n' + (err.message || err));
  }
});

// =============== –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞ ===
document.getElementById('jsonFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const fileNameEl = document.getElementById('fileNameDisplay');
  if (file) {
    fileNameEl.textContent = file.name;
    fileNameEl.style.color = '#4a90e2';
  } else {
    fileNameEl.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
    fileNameEl.style.color = 'var(--text-light)';
  }
});

async function loadJsonFromFile() {
  const fileInput = document.getElementById('jsonFile');
  const file = fileInput.files[0];
  if (!file) {
    showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª JSON.');
    return;
  }

  try {
    await ensureLoaded();
    const text = await file.text();
    const json = JSON.parse(text);

    const myData = json?.result?.GuildKeepData?.MyKeepData;
    const oppData = json?.result?.GuildKeepData?.OpponentKeepData;
    const oppName = oppData?.GuildData?.Name || '–ì–∏–ª—å–¥–∏—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';

    renderGuildSection('myKeep', myData, 'myTitle', '–ú–æ—è –≥–∏–ª—å–¥–∏—è');
    renderGuildSection('opponentKeep', oppData, 'oppTitle', oppName);

    hideError();
  } catch (e) {
    console.error(e);
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:\n' + (e.message || e));
  }
}

// –ê–≤—Ç–æ-–≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è Invite Code
document.getElementById('inviteCode').addEventListener('input', function () {
  const start = this.selectionStart;
  const end = this.selectionEnd;
  this.value = this.value.toUpperCase();
  this.setSelectionRange(start, end);
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadEventsFile);
</script>
</body>
</html>
