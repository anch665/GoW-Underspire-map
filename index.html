<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Underspire Map Live</title>
  <style>
    body {
      background: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin: 0;
    }
    h2 {
      margin-bottom: 15px;
    }

    /* === Upload === */
    .upload-container {
      display: flex;
      gap: 20px;
      width: 100%;
      max-width: 900px;
      margin-bottom: 20px;
    }
    .upload-box {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      flex: 1;
    }
    .upload-box h3 {
      margin-top: 0;
      font-size: 16px;
    }

    .drop-zone {
      border: 2px dashed #555;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
      background: #252525;
      transition: background 0.3s;
      cursor: pointer;
      font-size: 14px;
    }
    .drop-zone.drag-over {
      background: #333;
      border-color: #4a90e2;
    }
    .file-label {
      color: #4a90e2;
      text-decoration: underline;
      cursor: pointer;
    }
    .file-label:hover {
      color: #357abd;
    }

    .text-input-container {
      display: flex;
      gap: 8px;
      width: 100%;
    }
    #jsonTextarea {
      flex: 1;
      height: 120px;
      background: #1e1e1e;
      color: #0f0;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      font-family: monospace;
      resize: none;
    }
    #submitTextBtn {
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 0 12px;
      font-size: 14px;
      height: 120px;
    }
    #submitTextBtn:hover {
      background: #357abd;
    }

    .error-box {
      background: #442222;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      width: 100%;
      max-width: 900px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    /* === Map === */
    .map-legend-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 10px;
    }
    .map-grid-container {
      width: fit-content;
    }
    .map-grid {
      display: grid;
      grid-template-columns: 32px repeat(20, 32px) 32px;
      grid-template-rows: auto repeat(20, 32px) auto;
      gap: 0;
      border: 2px solid #555;
    }
    .axis-label {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      background: #333;
      color: #aaa;
      user-select: none;
    }
    .y-label {
      background: #2d2d2d !important;
      border-right: 1px solid #555;
      border-left: 1px solid #555;
    }
    .cell {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      border: 1px solid #000;
      box-sizing: border-box;
      position: relative;
    }
    .empty { background-color: #2a2a2a; }
    .room { background-color: #ffffff; color: #000; }
    .completed { background-color: #87CEFA; color: #000; }
    .treasure {
      background-color: #FFD700;
      color: #000;
      font-weight: bold;
      font-size: 10px;
    }
    .boss {
      background-color: #32CD32;
      color: #000;
      font-weight: bold;
      font-size: 10px;
    }
    .gate {
      background-color: #FF4500;
      color: white;
      font-weight: bold;
      font-size: 10px;
    }
    .collected-generic {
      background-color: #90EE90; /* lightgreen */
      color: #000;
    }
    .current-location {
      border: 5px solid #0000FF !important;
      box-sizing: border-box;
      width: 31px;
      height: 31px;
      z-index: 10;
    }
    .special-completed {
      border: 3px solid #FFA500 !important;
      box-sizing: border-box;
      width: 31px;
      height: 31px;
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è ExtraRooms */
    .cell:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -36px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 4px 6px;
      border-radius: 3px;
      font-size: 10px;
      white-space: pre;
      z-index: 100;
      text-align: center;
    }

    /* === Legend === */
    .legend {
      width: 280px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #2a2a2a;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    .legend-color {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <h2>Underspire Map Live (20√ó20)</h2>
  <div id="errorBox" class="error-box" style="display:none;"></div>

  <div class="upload-container">
    <div class="upload-box left">
      <h3>üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
      <div id="dropZone" class="drop-zone">
        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ JSON-—Ñ–∞–π–ª –∏–ª–∏ 
        <label for="fileInput" class="file-label">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
      </div>
    </div>
    <div class="upload-box right">
      <h3>‚úçÔ∏è –í—Å—Ç–∞–≤–∏—Ç—å JSON</h3>
      <div class="text-input-container">
        <textarea id="jsonTextarea" placeholder='{"result":{"Info":{...}}}'>{"result":{"Info":{"UnderspireData":{"Seed":-1657572488,"Gates":{"0":{"Node":605,"Dir":3},"1":{"Node":505,"Dir":1},"2":{"Node":710,"Dir":1},"3":{"Node":816,"Dir":1},"4":{"Node":819,"Dir":0},"5":{"Node":416,"Dir":3}},"CurrentNode":504,"Completed":[600,601,602,702,703,704,705,605,803,903,9003,1004,904,905,9002,8902,604,8504],"Collected":[702,704,605,1003,1002,902,504],"MerchantData":[100,0,2,3,5,1,4,0,5,1,3,0],"ExtraRooms":[{"RoomId":205,"TypeId":0,"Data":912},{"RoomId":606,"TypeId":1,"Data":1013},{"RoomId":1013,"TypeId":1,"Data":606},{"RoomId":514,"TypeId":4,"Data":16},{"RoomId":819,"TypeId":3,"Data":1},{"RoomId":1014,"TypeId":2},{"RoomId":404,"TypeId":2},{"RoomId":507,"TypeId":2},{"RoomId":305,"TypeId":5,"Data":16220},{"RoomId":810,"TypeId":5,"Data":16220},{"RoomId":1119,"TypeId":5,"Data":16220},{"RoomId":1003,"TypeId":5,"Data":16220},{"RoomId":508,"TypeId":5,"Data":16220},{"RoomId":515,"TypeId":5,"Data":16220},{"RoomId":1002,"TypeId":5,"Data":16220},{"RoomId":218,"TypeId":5,"Data":16220},{"RoomId":1019,"TypeId":5,"Data":16220},{"RoomId":609,"TypeId":5,"Data":16220},{"RoomId":504,"TypeId":5,"Data":16220},{"RoomId":816,"TypeId":5,"Data":16220},{"RoomId":710,"TypeId":5,"Data":16220},{"RoomId":506,"TypeId":5,"Data":16220},{"RoomId":618,"TypeId":5,"Data":16220},{"RoomId":1216,"TypeId":5,"Data":16220},{"RoomId":611,"TypeId":5,"Data":16220},{"RoomId":417,"TypeId":5,"Data":16220},{"RoomId":419,"TypeId":5,"Data":16220},{"RoomId":914,"TypeId":5,"Data":16220}],"DataVersion":11,"FreeOfferAvailable":false,"BossRoomInfo":{"104":16161,"319":16162,"415":16166,"905":16165,"916":16164,"1006":16160,"1115":16163},"TreasureRooms":[16167,16168,16169,16170,16171,16172,16173,16174,16175,16176,16177,16178,16179,16180,16181,16182,16183,16184,16185,16186,16187,16188,16189,16190,16191,16192,16193,16194,16195,16196,16197,16198,16199,16200,16201,16202],"TreasureRoomInfo":{"5":16193,"217":16197,"310":16201,"400":16185,"413":16191,"501":16170,"616":16185,"706":16179,"902":16177,"911":16194,"1009":16182,"1011":16197,"1114":16179,"1218":16191,"1317":16174}}}}}</textarea>
        <button type="button" id="submitTextBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="mapContainer"></div>

  <script>
    function _parsePosition(roomId) {
      const s = String(roomId).padStart(4, '0');
      if (s.length !== 4) return null;
      const y = parseInt(s.slice(0, 2), 10);
      const x = parseInt(s.slice(2), 10);
      if (y >= 0 && y < 20 && x >= 0 && x < 20) return [y, x];
      return null;
    }

    function _parseRoomsDict(roomDict) {
      const result = {};
      for (const [coordKey, roomId] of Object.entries(roomDict)) {
        const pos = _parsePosition(coordKey);
        if (pos) result[pos.join(',')] = roomId;
      }
      return result;
    }

    function parseMapData(dataJson) {
      try {
        const { result } = dataJson;
        const mapData = result.Info.UnderspireData.Map;
        const completedIds = result.Info.UnderspireData.Completed || [];
        const treasureInfo = result.Info.UnderspireData.TreasureRoomInfo || {};
        const bossInfo = result.Info.UnderspireData.BossRoomInfo || {};
        const gatesInfo = result.Info.UnderspireData.Gates || {};
        const collectedRaw = result.Info.UnderspireData.Collected || [];
        const extraRooms = result.Info.UnderspireData.ExtraRooms || [];
        const current_node = result.Info.UnderspireData.CurrentNode;

        const currentPos = _parsePosition(current_node);

        const completedCoords = new Set();
        for (const id of completedIds) {
          const num = Number(id);
          if (!isNaN(num) && num >= 0 && num <= 1919) {
            const pos = _parsePosition(num);
            if (pos) completedCoords.add(pos.join(','));
          }
        }

        const treasureRooms = _parseRoomsDict(treasureInfo);
        const bossRooms = _parseRoomsDict(bossInfo);

        const collectedCoords = new Set();
        for (const id of collectedRaw) {
          const num = Number(id);
          if (!isNaN(num) && num >= 0 && num <= 1919) {
            const pos = _parsePosition(num);
            if (pos) collectedCoords.add(pos.join(','));
          }
        }

        const collectedTreasureCoords = new Set(
          Object.keys(treasureRooms).filter(key => collectedCoords.has(key))
        );

        const gateCells = {};
        const gatePairs = {};
        for (const [gateId, gateData] of Object.entries(gatesInfo)) {
          const node = gateData.Node;
          const direction = gateData.Dir;
          const basePos = _parsePosition(node);
          if (!basePos) continue;

          const [y, x] = basePos;
          let cells;
          if (direction === 1) { // right
            cells = [[y, x], [y, x + 1]];
          } else if (direction === 3) { // left
            cells = [[y, x], [y, x - 1]];
          } else if (direction === 0) { // up
            cells = [[y, x], [y - 1, x]];
          } else if (direction === 2) { // down
            cells = [[y, x], [y + 1, x]];
          } else continue;

          if (cells.every(([cy, cx]) => cy >= 0 && cy < 20 && cx >= 0 && cx < 20)) {
            gatePairs[gateId] = cells;
            for (const cell of cells) {
              gateCells[cell.join(',')] = gateId;
            }
          }
        }

        // === –ü–ê–†–°–ò–ú ExtraRooms ===
        const extraRoomsMap = {};
        for (const er of extraRooms) {
          const roomId = er.RoomId;
          const pos = _parsePosition(roomId);
          if (pos) {
            const key = pos.join(',');
            extraRoomsMap[key] = {
              TypeId: er.TypeId,
              Data: er.Data !== undefined ? er.Data : null
            };
          }
        }

        // === –°–û–ë–ò–†–ê–ï–ú –í–°–ï "–û–°–û–ë–ï–ù–ù–´–ï" –ö–û–û–†–î–ò–ù–ê–¢–´ ===
        const specialCoords = new Set();

        for (const cells of Object.values(gatePairs)) {
          for (const [y, x] of cells) {
            specialCoords.add(`${y},${x}`);
          }
        }
        Object.keys(treasureRooms).forEach(key => specialCoords.add(key));
        Object.keys(bossRooms).forEach(key => specialCoords.add(key));

        return {
          mapData,
          completedCoords,
          treasureRooms,
          bossRooms,
          gateCells,
          gatePairs,
          collectedCoords,
          collectedTreasureCoords,
          currentPos,
          specialCoords,
          extraRoomsMap
        };
      } catch (e) {
        throw new Error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: " + (e.message || e));
      }
    }

    function renderMap(data) {
      const {
        mapData,
        completedCoords,
        treasureRooms,
        bossRooms,
        gateCells,
        gatePairs,
        collectedCoords,
        collectedTreasureCoords,
        currentPos,
        specialCoords,
        extraRoomsMap
      } = data;

      const rows = 20, cols = 20;

      let totalRooms = 0, remainingRooms = 0;
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          if (mapData[y][x] !== 15) {
            totalRooms++;
            if (!completedCoords.has(`${y},${x}`)) remainingRooms++;
          }
        }
      }

      const axisLabels = Array.from({length: cols}, (_, x) =>
        `<div class="axis-label">${x}</div>`
      ).join('');

      let mapRows = '';
      for (let y = 0; y < rows; y++) {
        let rowCells = `<div class="axis-label y-label">${y}</div>`;
        for (let x = 0; x < cols; x++) {
          const cellValue = mapData[y][x];
          const posKey = `${y},${x}`;
          let cssClasses = ['cell'];
          let displayText = '';
          let isSpecial = false;
          let tooltipLines = [`ID: ${cellValue}`];

          if (bossRooms[posKey] !== undefined) {
            cssClasses.push('boss');
            displayText = String(bossRooms[posKey]);
            isSpecial = true;
          } else if (treasureRooms[posKey] !== undefined) {
            cssClasses.push('treasure');
            displayText = String(treasureRooms[posKey]);
            isSpecial = true;
          } else if (gateCells[posKey] !== undefined) {
            const gid = gateCells[posKey];
            cssClasses.push('gate');
            displayText = String(Number(gid) + 1);
            isSpecial = true;
          } else if (collectedCoords.has(posKey) && !specialCoords.has(posKey)) {
            cssClasses.push('collected-generic');
          } else if (cellValue === 15) {
            cssClasses.push('empty');
          } else if (completedCoords.has(posKey)) {
            cssClasses.push('completed');
          } else {
            cssClasses.push('room');
          }

          // === –î–û–ë–ê–í–õ–Ø–ï–ú "E" –¥–ª—è ExtraRooms ===
          let hasExtra = extraRoomsMap.hasOwnProperty(posKey);
          if (hasExtra) {
            const extra = extraRoomsMap[posKey];
            tooltipLines.push(`Extra: Type=${extra.TypeId}, Data=${extra.Data !== null ? extra.Data : '‚Äî'}`);
		    if (extra.TypeId === 5 && extra.Data === 16220) {
			  tooltipLines.push('–°–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü–∞');
			}
            if (displayText) {
              displayText += ', E';
            } else {
              displayText = 'E';
            }
          }

          if (isSpecial && completedCoords.has(posKey)) {
            cssClasses.push('special-completed');
          }

          if (currentPos && currentPos[0] === y && currentPos[1] === x) {
            cssClasses.push('current-location');
          }

          if (collectedTreasureCoords.has(posKey)) {
            cssClasses.push('special-completed');
          }

          const tooltip = tooltipLines.join('\n');
          const classStr = cssClasses.join(' ');
          rowCells += `<div class="${classStr}" data-tooltip="${tooltip}">${displayText}</div>`;
        }
        rowCells += `<div class="axis-label y-label">${y}</div>`;
        mapRows += `<div style="display:contents;">${rowCells}</div>`;
      }

      const legendHtml = `
        <div class="legend-item"><div class="legend-color" style="border:5px solid #0000FF;"></div><span>–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#FF4500;"></div><span>–í–æ—Ä–æ—Ç–∞ (ID ‚Äî –Ω–æ–º–µ—Ä –ø–∞—Ä—ã)</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#FFD700;"></div><span>–°—Ç—Ä–∞–∂ —Å–æ–∫—Ä–æ–≤–∏—â–∞</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#32CD32;"></div><span>–ë–æ—Å—Å (–∫–ª—é—á)</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#90EE90;"></div><span>–°–æ–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ã—á–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#87CEFA;"></div><span>–ü–æ—Å–µ—â—ë–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#ffffff;"></div><span>–ö–æ–º–Ω–∞—Ç—ã (–Ω–µ –ø–æ—Å–µ—â–µ–Ω—ã)</span></div>
        <div class="legend-item"><div class="legend-color" style="border:3px solid #FFA500;"></div><span>–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –æ—Å–æ–±—ã–µ –∫–æ–º–Ω–∞—Ç—ã</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#aaa;font-weight:bold;color:#000;">E</div><span>–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (ExtraRooms)</span></div>
      `;

      const stats = `
        <p>
          –ü—Ä–æ–π–¥–µ–Ω–æ: ${completedCoords.size} | 
          –°–æ–∫—Ä–æ–≤–∏—â: ${Object.keys(treasureRooms).length} (—Å–æ–±—Ä–∞–Ω–æ: ${collectedTreasureCoords.size}) | 
          –ë–æ—Å—Å–æ–≤: ${Object.keys(bossRooms).length} | 
          –í–æ—Ä–æ—Ç: ${Object.keys(gatePairs).length} |
          Extra: ${Object.keys(extraRoomsMap).length}
        </p>
        <p><strong>–ö–æ–º–Ω–∞—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è: ${remainingRooms} –∏–∑ ${totalRooms}</strong></p>
      `;

      return `
        ${stats}
        <div class="map-legend-container">
          <div class="map-grid-container">
            <div class="map-grid">
              <div class="axis-label"></div>
              ${axisLabels}
              <div class="axis-label"></div>
              ${mapRows}
              <div class="axis-label"></div>
              ${axisLabels}
              <div class="axis-label"></div>
            </div>
          </div>
          <div class="legend">
            ${legendHtml}
          </div>
        </div>
      `;
    }

    function showError(msg) {
      const el = document.getElementById('errorBox');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorBox').style.display = 'none';
    }

    function processData(jsonData) {
      try {
        const data = parseMapData(jsonData);
        const html = renderMap(data);
        document.getElementById('mapContainer').innerHTML = html;
        hideError();
      } catch (e) {
        showError(e.message || String(e));
      }
    }

    // ======================
    // üñ±Ô∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    // ======================

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        processData(json);
      } catch (err) {
        showError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON-—Ñ–∞–π–ª: " + (err.message || err));
      }
    });

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
    });

    dropZone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length) {
        fileInput.files = files;
        fileInput.dispatchEvent(new Event('change'));
      }
    });

    document.getElementById('submitTextBtn').addEventListener('click', () => {
      const text = document.getElementById('jsonTextarea').value.trim();
      if (!text) {
        showError('–ü–æ–ª–µ JSON –ø—É—Å—Ç–æ');
        return;
      }
      try {
        const json = JSON.parse(text);
        processData(json);
      } catch (err) {
        showError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: " + (err.message || err));
      }
    });
  </script>
</body>
</html>
