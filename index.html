<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Underspire Map Viewer</title>
<style>
/* === –û–±—â–∏–µ —Å—Ç–∏–ª–∏ === */
body {
  background: #1e1e1e;
  color: white;
  font-family: 'Segoe UI', Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  margin: 0;
}
h2 {
  margin-bottom: 5px;
  font-size: 20px;
}

/* === –û—Å–Ω–æ–≤–Ω–æ–π –º–∞–∫–µ—Ç === */
.main-layout {
  display: flex;
  gap: 20px;
  width: 100%;
  max-width: 1200px;
  margin-top: 10px;
}

/* === –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å === */
.left-panel {
  width: 300px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 20px;
}
.upload-box, .online-box {
  background: #2d2d2d;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.upload-box h3, .online-box h3 {
  margin-top: 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.upload-box h3::before {
  content: "üìÅ";
  font-size: 18px;
}
.online-box h3::before {
  content: "üåê";
  font-size: 18px;
}
.drop-zone {
  border: 2px dashed #555;
  border-radius: 6px;
  padding: 20px;
  text-align: center;
  background: #252525;
  transition: background 0.3s;
  cursor: pointer;
  font-size: 14px;
  margin-top: 10px;
}
.drop-zone.drag-over {
  background: #333;
  border-color: #4a90e2;
}
.file-label {
  color: #4a90e2;
  text-decoration: underline;
  cursor: pointer;
}
.file-label:hover {
  color: #357abd;
}
.online-box input {
  width: 100%;
  padding: 5px;
  background: #1e1e1e;
  color: white;
  border: 1px solid #444;
  border-radius: 3px;
  margin: 5px 0;
  font-size: 13px;
}
.online-box button,
#downloadPngBtn,
#downloadJsonBtn,
#tileSizeSelectBtn {
  background: #4a90e2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  padding: 10px;
  font-size: 14px;
  width: 100%;
  white-space: nowrap;
  margin-top: 10px;
}
.online-box button:hover,
#downloadPngBtn:hover,
#tileSizeSelectBtn:hover {
  background: #357abd;
}
#downloadJsonBtn {
  background: #2e7d32;
}
#downloadJsonBtn:hover {
  background: #1b5e20;
}

/* === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ === */
.stats {
  text-align: left;
  margin: 10px 0;
  font-size: 14px;
  color: #ccc;
  background: #2d2d2d;
  padding: 10px;
  border-radius: 6px;
  max-width: 1400px;
}
.stats strong {
  color: #fff;
  font-weight: bold;
}

/* === –ö–∞—Ä—Ç–∞ === */
#map-wrapper {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  overflow: hidden;
  background: #2d2d2d;
  padding: 32px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
#map-container {
  display: grid;
  gap: 0;
  position: relative;
  background: #111;
  border: 2px solid #444;
  max-width: 100%;
}
.tile {
  background-size: cover;
  image-rendering: pixelated;
  background-color: transparent;
  position: relative;
}
.tile-bg {
  width: 100%;
  height: 100%;
  background-size: cover;
  image-rendering: pixelated;
}
.overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  image-rendering: pixelated;
  pointer-events: none;
}
.trap-overlay { background-image: url('tiles/trap.png'); }
.oracle-overlay { background-image: url('tiles/oracle.png'); }
.secret-overlay { background-image: url('tiles/secret.png'); }
.trinket-overlay { background-image: url('tiles/trinket.png'); }
.powder-overlay { background-image: url('tiles/powder.png'); }
.cursedmine-overlay { background-image: url('tiles/cursedmine.png'); }
.treasure-overlay { background-image: url('tiles/treasure.png'); }
.entrance-overlay { background-image: url('tiles/entrance.png'); }
.merchant-overlay { background-image: url('tiles/merchant.png'); }
.boss7-overlay { background-image: url('tiles/boss7.png'); }
.treasure-guard-overlay {
  background-image: var(--guard-url);
}
.done-overlay {
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 10px;
  color: #0f0;
  font-family: Arial, sans-serif;
  text-shadow: 0 0 2px #000;
}
.empty {
  background-color: #111;
}
.y-label, .y-label-right {
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #888;
  pointer-events: none;
  z-index: 5;
}
.y-label {
  left: -30px;
}
.y-label-right {
  right: -30px;
}
.x-label, .x-label-top {
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #888;
  pointer-events: none;
  z-index: 5;
}
.x-label {
  bottom: -30px;
}
.x-label-top {
  top: -30px;
}
.keystone {
  position: absolute;
  image-rendering: pixelated;
  pointer-events: none;
  z-index: 10;
}
.tile-tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  padding: 4px 8px;
  border-radius: 3px; /* —á—É—Ç—å –±–æ–ª—å—à–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
  font-size: 12px;
  /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã */
  width: max-content;
  min-width: unset;
  max-width: unset;
  /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–æ–ª—å–∫–æ –ø–æ —Å–∏–º–≤–æ–ª–∞–º \n, –Ω–æ –Ω–µ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ */
  white-space: pre-line; /* —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç \n, –Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
  word-break: break-word; /* –Ω–∞ —Å–ª—É—á–∞–π –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ */
  text-align: center;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 20;
}
.tile:hover .tile-tooltip {
  opacity: 1;
}

/* === –õ–µ–≥–µ–Ω–¥–∞ === */
.legend {
  width: 200px;
  flex-shrink: 0;
  background: #2d2d2d;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 8px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  gap: 4px;
  overflow-y: auto;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  font-size: 12px;
}
.legend-color {
  width: 24px;
  height: 24px;
  background-size: cover;
  image-rendering: pixelated;
  margin: 0;
  border: 1px solid #555;
  border-radius: 2px;
}

/* === –û—à–∏–±–∫–∏ === */
.error-box {
  background: #442222;
  padding: 15px;
  border-radius: 6px;
  margin: 10px 0;
  width: 100%;
  max-width: 1600px;
  font-family: monospace;
  white-space: pre-wrap;
  font-size: 14px;
  display: none;
}

/* === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ === */
#tileSizeModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
#tileSizeModalContent {
  background: #2d2d2d;
  padding: 20px;
  border-radius: 8px;
  width: 250px;
}
#tileSizeModalContent h3 {
  margin-top: 0;
  margin-bottom: 15px;
  text-align: center;
}
.size-option {
  display: block;
  width: 100%;
  padding: 10px;
  margin: 5px 0;
  background: #444;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}
.size-option:hover {
  background: #555;
}
.size-option.active {
  background: #4a90e2;
}
</style>
</head>
<body>
<h2>Underspire Map Viewer</h2>
<div id="errorBox" class="error-box"></div>

<div class="main-layout">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
  <div class="left-panel">
    <div class="upload-box">
      <h3>Stats</h3>
      <div id="mapStats" class="stats" style="display:none;"></div>
    </div>
    <!-- –û–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∞ -->
		<div class="online-box">
			<h3>Get Map Online</h3>
			<form id="onlineForm">
				<label>Invite Code:
					<input type="text" id="onlineNameCode" value="" placeholder="Invite code" autocomplete="username">
				</label>
				<label>Password:
					<input type="password" id="onlinePassword" value="" placeholder="Your password" autocomplete="current-password">
				</label>
				<button type="submit">Get Map</button>
			</form>
		</div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <div class="upload-box">
      <h3>Upload JSON file</h3>
      <div id="dropZone" class="drop-zone">
        Drag and drop a JSON file here or
        <label for="fileInput" class="file-label">select a file</label>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
      </div>
    </div>
 
    <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="upload-box">
      <h3>Export</h3>
      <button type="button" id="downloadPngBtn">Download map (PNG)</button>
      <button type="button" id="downloadJsonBtn">Save JSON</button>
    </div>
    <div class="upload-box">
      <h3>Options</h3>
      <button type="button" id="tileSizeSelectBtn">Map cell size: <span id="currentTileSize">48</span> px</button>
    </div>
  </div>

  <!-- –¶–µ–Ω—Ç—Ä: –∫–∞—Ä—Ç–∞ -->
  <div style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
    <div id="map-wrapper">
      <div id="map-container"></div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ -->
<div id="tileSizeModal">
  <div id="tileSizeModalContent">
    <h3>Select cell size</h3>
    <button class="size-option" data-size="32">32 px</button>
    <button class="size-option active" data-size="48">48 px</button>
    <button class="size-option" data-size="64">64 px</button>
  </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º html2canvas –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PNG -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const container = document.getElementById('map-container');
const statsEl = document.getElementById('mapStats');
const errorBox = document.getElementById('errorBox');
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const downloadPngBtn = document.getElementById('downloadPngBtn');
const downloadJsonBtn = document.getElementById('downloadJsonBtn');
const fetchOnlineMapBtn = document.getElementById('fetchOnlineMapBtn');
const onlineNameCode = document.getElementById('onlineNameCode');
const onlinePassword = document.getElementById('onlinePassword');
const tileSizeSelectBtn = document.getElementById('tileSizeSelectBtn');
const currentTileSizeEl = document.getElementById('currentTileSize');
const tileSizeModal = document.getElementById('tileSizeModal');
document.getElementById('onlineForm').addEventListener('submit', (e) => {
  e.preventDefault(); // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  const nameCode = onlineNameCode.value.trim();
  const password = onlinePassword.value;
  if (!nameCode || !password) {
    showError("–í–≤–µ–¥–∏—Ç–µ NameCode –∏ –ø–∞—Ä–æ–ª—å");
    return;
  }
  fetchOnlineMap(nameCode, password);
});

let tileSize = 48;
let lastDataJson = null;
let currentLiveEventId = null;

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
onlineNameCode.addEventListener('input', function () {
  const start = this.selectionStart;
  const end = this.selectionEnd;
  this.value = this.value.toUpperCase();
  this.setSelectionRange(start, end);
});

let bossInfoMap = {};
let treasureInfoMap = {};

async function loadDescriptions() {
  try {
    const res = await fetch('info.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    bossInfoMap = data.BossInfo || {};
    treasureInfoMap = data.TreasureInfo || {};
  } catch (err) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å info.json:', err);
    showError('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å info.json ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º–∏.');
  }
}

function showError(msg) {
  errorBox.textContent = msg;
  errorBox.style.display = 'block';
}
function hideError() {
  errorBox.style.display = 'none';
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const json = JSON.parse(text.trim());
    lastDataJson = json;
    currentLiveEventId = null;
    await processData(json);
  } catch (err) {
    showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: " + (err.message || err));
  }
});

// Drag & Drop
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  });
});
['dragenter', 'dragover'].forEach(eventName => {
  dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
});
['dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
});
dropZone.addEventListener('drop', (e) => {
  const files = e.dataTransfer.files;
  if (files.length) {
    fileInput.files = files;
    fileInput.dispatchEvent(new Event('change'));
  }
});

// –û–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∞
async function fetchOnlineMap(nameCode, password) {
  try {
    const nowUtc = Date.now();
    const nowUtcMinus7 = nowUtc + 7 * 3600 * 1000;
    const unixWeeks = Math.floor(nowUtcMinus7 / 1000 / 604800);
    const LiveEventId = unixWeeks - 2506;
    currentLiveEventId = LiveEventId;

    const apiUrl = "https://pcmob.parse.gemsofwar.com/call_function";

    const profileReq = {
      functionName: "get_hero_profile",
      NameCode: nameCode
    };

    let resp1 = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(profileReq)
    });

    if (!resp1.ok) throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: ${resp1.status} ${resp1.statusText}`);
    const profileData = await resp1.json();
    const username = profileData?.result?.ProfileData?.username;

    if (!username || username === "null") {
      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å username –ø–æ NameCode");
    }

    const mapReq = {
      functionName: "live_event_get_info",
      username: username,
      password: password,
      LiveEventId: LiveEventId,
      LiveEventType: 17
    };

    let resp2 = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mapReq)
    });

    if (!resp2.ok) throw new Error(`–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã: ${resp2.status} ${resp2.statusText}`);
    const mapData = await resp2.json();
    lastDataJson = mapData;
    await processData(mapData);

  } catch (err) {
    console.error("–û–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:", err);
    showError("–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∏: " + (err.message || err));
  }
}
/*
fetchOnlineMapBtn.addEventListener('click', () => {
  const nameCode = onlineNameCode.value.trim();
  const password = onlinePassword.value;
  if (!nameCode || !password) {
    showError("–í–≤–µ–¥–∏—Ç–µ NameCode –∏ –ø–∞—Ä–æ–ª—å");
    return;
  }
  fetchOnlineMap(nameCode, password);
});
*/
// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ JSON
function exportToJson() {
  if (!lastDataJson) {
    showError("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç—É.");
    return;
  }
  
  const underspireData = lastDataJson?.result?.Info?.UnderspireData;
  if (!underspireData) {
    showError("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ UnderspireData –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ.");
    return;
  }
  
  const nameCode = onlineNameCode.value.trim().toUpperCase();
  const eventId = currentLiveEventId || 'unknown';
  const now = new Date();
  
  let filename = nameCode
    ? `underspire_${nameCode}_${eventId}_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.json`
    : `underspire_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.json`;
  
  const exportUnderspireData = JSON.parse(JSON.stringify(underspireData));
  if (exportUnderspireData.Seed !== undefined) {
    delete exportUnderspireData.Seed;
  }
  
  const exportData = {
    "result": {
      "Info": {
        "UnderspireData": exportUnderspireData
      }
    }
  };
  
  const jsonString = JSON.stringify(exportData, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 100);
}

downloadJsonBtn.addEventListener('click', exportToJson);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
async function processData(dataJson) {
  await loadDescriptions();
  try {
    const underspire = dataJson?.result?.Info?.UnderspireData;
    if (!underspire) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ result.Info.UnderspireData');

    const map = underspire.Map;
    const extraRooms = underspire.ExtraRooms || [];
    const completed = underspire.Completed || [];
    const collected = underspire.Collected || [];
    const gates = underspire.Gates || {};
    const bossRoomInfo = underspire.BossRoomInfo || {};
    const treasureRoomInfo = underspire.TreasureRoomInfo || {};

    if (!map || !Array.isArray(map) || map.length === 0 || !Array.isArray(map[0])) {
      throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç—ã');
    }

    const bossPositions = {};
    for (const [roomIdStr, bossId] of Object.entries(bossRoomInfo)) {
      const roomId = parseInt(roomIdStr, 10);
      if (isNaN(roomId)) continue;
      const y = Math.floor(roomId / 100);
      const x = roomId % 100;
      bossPositions[`${y},${x}`] = { id: bossId };
    }

    const treasurePositions = {};
    for (const [roomIdStr, treasureId] of Object.entries(treasureRoomInfo)) {
      const roomId = parseInt(roomIdStr, 10);
      if (isNaN(roomId)) continue;
      const y = Math.floor(roomId / 100);
      const x = roomId % 100;
      treasurePositions[`${y},${x}`] = treasureId;
    }

    const specialRooms = {};
    for (const room of extraRooms) {
      if (room.TypeId != null && room.RoomId != null) {
        const xx = room.RoomId % 100;
        const yy = Math.floor(room.RoomId / 100);
        specialRooms[`${yy},${xx}`] = room.TypeId;
      }
    }

    const donePositions = new Set();
    const allDoneIds = [...completed, ...collected];
    for (const roomId of allDoneIds) {
      const xx = roomId % 100;
      const yy = Math.floor(roomId / 100);
      donePositions.add(`${yy},${xx}`);
    }

    function calculateStats(map, extraRooms, donePositions) {
      const AUTO_TYPE_IDS = new Set([0, 1, 2, 3, 4]);
      function isAutoRoomByValue(value) {
        if (value === 15) return false;
        const hex = value.toString(16).toUpperCase();
        if (hex.length < 2) return false;
        const penultimate = hex[hex.length - 2];
        return penultimate === '1' || penultimate === 'B';
      }

      const specialMap = {};
      for (const room of extraRooms) {
        if (room.TypeId != null && room.RoomId != null) {
          const xx = room.RoomId % 100;
          const yy = Math.floor(room.RoomId / 100);
          specialMap[`${yy},${xx}`] = room.TypeId;
        }
      }

      let totalRooms = 0;
      let openedAllCount = 0;
      let progressRemaining = 0;

      for (let y = 0; y < map.length; y++) {
        for (let x = 0; x < map[y].length; x++) {
          const value = map[y][x];
          if (value === 15) continue;
          totalRooms++;
          const roomKey = `${y},${x}`;
          const isDone = donePositions.has(roomKey);
          if (isDone) openedAllCount++;
          const typeId = specialMap[roomKey];
          const isAutoByType = typeId != null && AUTO_TYPE_IDS.has(typeId);
          const isAutoByValue = isAutoRoomByValue(value);
          const isAuto = isAutoByType || isAutoByValue;
          if (!isAuto && !isDone) {
            progressRemaining++;
          }
        }
      }
      return { totalRooms, openedAll: openedAllCount, progressRemaining };
    }

    const stats = calculateStats(map, extraRooms, donePositions);
    statsEl.innerHTML = `
      Total rooms: <b>${stats.totalRooms}</b><br>
      Open: <b>${stats.openedAll}</b><br>
      Remaining: <b>${stats.progressRemaining}</b>
    `;
    statsEl.style.display = 'block';

    renderMap(map, specialRooms, donePositions, bossPositions, treasurePositions, tileSize);
    renderGates(map, gates, tileSize);
    addCoordinateLabels(map, tileSize);

    hideError();
  } catch (e) {
    showError("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + (e.message || e));
  }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç—ã
const typeToClass = {0:'oracle-overlay',1:'secret-overlay',2:'trinket-overlay',3:'powder-overlay',4:'cursedmine-overlay',5:'treasure-overlay'};
const typeIdToName = {0:'Oracle',1:'Secret',2:'Trinket',3:'Powder',4:'Cursed Mine',5:'Treasure'};

function renderMap(map, specialRooms, donePositions, bossPositions, treasurePositions, size) {
  const rows = map.length;
  const cols = map[0]?.length || 0;
  container.dataset.rows = rows;
  container.dataset.cols = cols;
  container.style.gridTemplateColumns = `repeat(${cols}, ${size}px)`;
  container.innerHTML = '';
  container.style.padding = "0";

  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const value = map[y][x];
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.style.width = `${size}px`;
      tile.style.height = `${size}px`;
      let hasContent = false;
      let tooltipTexts = [];

      if (value === 15) {
        tile.classList.add('empty');
      } else {
        const hex = value.toString(16).toUpperCase();
        const lastHexChar = hex.slice(-1);
        if (lastHexChar >= '0' && lastHexChar <= 'E') {
          const bg = document.createElement('div');
          bg.className = 'tile-bg';
          bg.style.backgroundImage = `url(tiles/${lastHexChar}.png)`;
          tile.appendChild(bg);
          hasContent = true;
        } else {
          tile.classList.add('empty');
        }

        if (hex.length >= 2) {
          const penultimate = hex[hex.length - 2];
          if (penultimate >= '2' && penultimate <= '7') {
            const guardIndex = parseInt(penultimate, 16) - 2;
            const guardNames = ['TG Common','TG Rare','TG Ultra-Rare','TG Epic','TG Legendary','TG Mythic'];
            const guardName = guardNames[guardIndex] || `TG Unknown (${penultimate})`;
            const guardNum = guardIndex + 1;
            const guard = document.createElement('div');
            guard.className = 'overlay treasure-guard-overlay';
            guard.style.backgroundImage = `url(tiles/treasure_guard${guardNum}.png)`;
            const guardScale = 0.75;
            guard.style.transform = `scale(${guardScale})`;
            guard.style.transformOrigin = 'center center';
            tile.appendChild(guard);
            tooltipTexts.push(guardName); // ‚Üê —Å–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤–æ–µ –∏–º—è
            hasContent = true;
          }
          if (penultimate === '1') {
            const entrance = document.createElement('div');
            entrance.className = 'overlay entrance-overlay';
            const entranceScale = 0.8;
            entrance.style.transform = `scale(${entranceScale})`;
            entrance.style.transformOrigin = 'center center';
            tile.appendChild(entrance);
            tooltipTexts.push('Entrance');
            hasContent = true;
          }
          if (penultimate === 'C') {
            const trap = document.createElement('div');
            trap.className = 'overlay trap-overlay';
            const trapScale = 0.55;
            trap.style.transform = `scale(${trapScale})`;
            trap.style.transformOrigin = 'center center';
            tile.appendChild(trap);
            tooltipTexts.push('Trap');
            hasContent = true;
          }
          if (penultimate === 'B') {
            const merchant = document.createElement('div');
            merchant.className = 'overlay merchant-overlay';
            const merchantScale = 0.85;
            merchant.style.transform = `scale(${merchantScale})`;
            merchant.style.transformOrigin = 'center center';
            tile.appendChild(merchant);
            tooltipTexts.push('Merchant');
            hasContent = true;
          }
        }
      }

      const roomKey = `${y},${x}`;

      // === –ë–æ—Å—Å—ã ===
      if (bossPositions[roomKey]) {
        const { id } = bossPositions[roomKey];
        const desc = bossInfoMap[id] || `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –±–æ—Å—Å (ID: ${id})`;
        const parts = desc.split(/,\s*/);
        const bossScale = 0.75;
        if (id === 16166) {
          const boss = document.createElement('div');
          boss.className = 'overlay boss7-overlay';
          boss.style.transform = `scale(${bossScale})`;
          boss.style.transformOrigin = 'center center';
          tile.appendChild(boss);
        } else {
          const img = document.createElement('img');
          img.src = `tiles/boss1-6.png`;
          img.className = 'overlay';
          Object.assign(img.style, {
            position: 'absolute',
            top: '0',
            left: '0',
            width: '100%',
            height: '100%',
            imageRendering: 'pixelated',
            pointerEvents: 'none',
            transform: `scale(${bossScale})`,
            transformOrigin: 'center center'
          });
          tile.appendChild(img);
        }
        tooltipTexts.push(...parts);
        hasContent = true;
      }

      // === –°–æ–∫—Ä–æ–≤–∏—â–∞: –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ TreasureInfo, –µ—Å–ª–∏ –µ—Å—Ç—å ===
      const treasureId = treasurePositions[roomKey];
      if (treasureId != null) {
        const desc = treasureInfoMap[treasureId] || `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ (ID: ${treasureId})`;
        const parts = desc.split(/,\s*/);
        tooltipTexts.push(...parts); // ‚Üê –¥–æ–±–∞–≤–ª—è–µ–º –∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "TG Common")
      }

      // === Special Rooms ===
      const typeId = specialRooms[roomKey];
      if (typeId != null && typeToClass.hasOwnProperty(typeId)) {
        const overlay = document.createElement('div');
        overlay.className = `overlay ${typeToClass[typeId]}`;
        const overlayScale = 0.85;
        overlay.style.transform = `scale(${overlayScale})`;
        overlay.style.transformOrigin = 'center center';
        tile.appendChild(overlay);
        tooltipTexts.push(typeIdToName[typeId] || `Special ${typeId}`);
        hasContent = true;
      }

      // === Done marker ===
      if (donePositions.has(roomKey)) {
        const done = document.createElement('div');
        done.className = 'overlay done-overlay';
        done.textContent = '‚úì';
        tile.appendChild(done);
      }

      // === Tooltip ===
      if (hasContent && tooltipTexts.length > 0) {
        const tooltip = document.createElement('div');
        tooltip.className = 'tile-tooltip';
        tooltip.textContent = tooltipTexts.join('\n');
        tile.appendChild(tooltip);
      }

      container.appendChild(tile);
    }
  }
}

function renderGates(map, gates, size) {
  const rows = map.length;
  const cols = map[0]?.length || 0;
  document.querySelectorAll('.keystone').forEach(el => el.remove());

  const keystoneScale = 0.75;
  for (const gateId in gates) {
    if (!gates.hasOwnProperty(gateId)) continue;
    const gate = gates[gateId];
    const nodeId = gate.Node;
    const dir = gate.Dir;

    const roomX = nodeId % 100;
    const roomY = Math.floor(nodeId / 100);
    if (roomY < 0 || roomY >= rows || roomX < 0 || roomX >= cols) continue;

    let neighborX = roomX, neighborY = roomY;
    if (dir === 0) neighborY--;
    else if (dir === 1) neighborX++;
    else if (dir === 2) neighborY++;
    else if (dir === 3) neighborX--;
    else continue;
    if (neighborY < 0 || neighborY >= rows || neighborX < 0 || neighborX >= cols) continue;

    const centerX1 = (roomX + 0.5) * size;
    const centerY1 = (roomY + 0.5) * size;
    const centerX2 = (neighborX + 0.5) * size;
    const centerY2 = (neighborY + 0.5) * size;
    const midX = (centerX1 + centerX2) / 2;
    const midY = (centerY1 + centerY2) / 2;
    const iconSize = size * keystoneScale;
    const keystoneLeft = midX - iconSize / 2;
    const keystoneTop = midY - iconSize / 2;

    const img = document.createElement('img');
    img.src = `tiles/keystones${gateId}.png`;
    img.className = 'keystone';
    img.style.width = `${iconSize}px`;
    img.style.height = `${iconSize}px`;
    img.style.left = `${keystoneLeft}px`;
    img.style.top = `${keystoneTop}px`;
    container.appendChild(img);
  }
}

function addCoordinateLabels(map, size) {
  const rows = map.length;
  const cols = map[0]?.length || 0;
  document.querySelectorAll('.y-label, .y-label-right, .x-label, .x-label-top').forEach(el => el.remove());

  for (let y = 0; y < rows; y++) {
    const labelL = document.createElement('div');
    labelL.className = 'y-label';
    labelL.style.top = `${y * size}px`;
    labelL.style.width = "30px";
    labelL.style.height = `${size}px`;
    labelL.textContent = y;
    container.appendChild(labelL);

    const labelR = document.createElement('div');
    labelR.className = 'y-label-right';
    labelR.style.top = `${y * size}px`;
    labelR.style.width = "30px";
    labelR.style.height = `${size}px`;
    labelR.textContent = y;
    container.appendChild(labelR);
  }

  for (let x = 0; x < cols; x++) {
    const labelT = document.createElement('div');
    labelT.className = 'x-label-top';
    labelT.style.left = `${x * size}px`;
    labelT.style.width = `${size}px`;
    labelT.style.height = "30px";
    labelT.textContent = x;
    container.appendChild(labelT);

    const labelB = document.createElement('div');
    labelB.className = 'x-label';
    labelB.style.left = `${x * size}px`;
    labelB.style.width = `${size}px`;
    labelB.style.height = "30px";
    labelB.textContent = x;
    container.appendChild(labelB);
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç PNG
downloadPngBtn.addEventListener('click', async () => {
  try {
    const canvas = await html2canvas(container, {
      backgroundColor: '#111',
      scale: 1,
      useCORS: true,
      allowTaint: true,
      logging: false
    });
    const link = document.createElement('a');
    link.download = 'underspire_map.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  } catch (err) {
    showError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PNG: ' + (err.message || err));
  }
});

// –í—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞
tileSizeSelectBtn.addEventListener('click', () => {
  tileSizeModal.style.display = 'flex';
});

document.querySelectorAll('.size-option').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.size-option').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    tileSize = parseInt(btn.dataset.size);
    currentTileSizeEl.textContent = tileSize;
    tileSizeModal.style.display = 'none';
    if (lastDataJson) {
      processData(lastDataJson);
    }
  });
});

window.addEventListener('click', (e) => {
  if (e.target === tileSizeModal) {
    tileSizeModal.style.display = 'none';
  }
});

// –û—Ç–ª–∞–¥–∫–∞
/*
window.debugMapViewer = {
  showCredentials: function() {
    return {
      nameCode: document.getElementById('onlineNameCode').value,
      password: document.getElementById('onlinePassword').value
    };
  },
  showLastData: function() {
    return lastDataJson;
  },
  showMapInfo: function() {
    if (!lastDataJson) return null;
    const map = lastDataJson.result?.Info?.UnderspireData?.Map;
    return {
      rows: map?.length || 0,
      cols: map?.[0]?.length || 0,
      completed: lastDataJson.result?.Info?.UnderspireData?.Completed?.length || 0,
      extraRooms: lastDataJson.result?.Info?.UnderspireData?.ExtraRooms?.length || 0,
      liveEventId: currentLiveEventId
    };
  },
  exportJson: exportToJson
};

console.log('Underspire Map Viewer debug –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ window.debugMapViewer');
*/
// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
(async () => {
  try {
    const res = await fetch('map.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    lastDataJson = data;
    currentLiveEventId = null;
    await processData(data);
  } catch (err) {
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å map.json: ' + (err.message || err));
  }
})();
</script>
</body>
</html>
