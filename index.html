<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Underspire Map Live</title>
  <style>
    body {
      background: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin: 0;
    }
    h2 {
      margin-bottom: 15px;
    }

    /* === Upload === */
    .upload-container {
      display: flex;
      gap: 20px;
      width: 100%;
      max-width: 900px;
      margin-bottom: 20px;
    }
    .upload-box {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      flex: 1;
    }
    .upload-box h3 {
      margin-top: 0;
      font-size: 16px;
    }

    .drop-zone {
      border: 2px dashed #555;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
      background: #252525;
      transition: background 0.3s;
      cursor: pointer;
      font-size: 14px;
    }
    .drop-zone.drag-over {
      background: #333;
      border-color: #4a90e2;
    }
    .file-label {
      color: #4a90e2;
      text-decoration: underline;
      cursor: pointer;
    }
    .file-label:hover {
      color: #357abd;
    }

    .text-input-container {
      display: flex;
      gap: 8px;
      width: 100%;
    }
    #jsonTextarea {
      flex: 1;
      height: 120px;
      background: #1e1e1e;
      color: #0f0;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      font-family: monospace;
      resize: none;
    }
    #submitTextBtn {
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 0 12px;
      font-size: 14px;
      height: 120px;
    }
    #submitTextBtn:hover {
      background: #357abd;
    }

    .error-box {
      background: #442222;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      width: 100%;
      max-width: 900px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    /* === Map === */
    .map-legend-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 10px;
    }
    .map-grid-container {
      width: fit-content;
    }
    .map-grid {
      display: grid;
      grid-template-columns: 32px repeat(20, 32px) 32px;
      grid-template-rows: auto repeat(20, 32px) auto;
      gap: 0;
      border: 2px solid #555;
    }
    .axis-label {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      background: #333;
      color: #aaa;
      user-select: none;
    }
    .y-label {
      background: #2d2d2d !important;
      border-right: 1px solid #555;
      border-left: 1px solid #555;
    }
    .cell {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      border: 1px solid #000;
      box-sizing: border-box;
      position: relative;
    }
    .empty { background-color: #2a2a2a; }
    .room { background-color: #ffffff; color: #000; }
    .completed { background-color: #87CEFA; color: #000; }
    .treasure {
      background-color: #FFD700;
      color: #000;
      font-weight: bold;
      font-size: 10px;
    }
    .boss {
      background-color: #32CD32;
      color: #000;
      font-weight: bold;
      font-size: 10px;
    }
    .gate {
      background-color: #FF4500;
      color: white;
      font-weight: bold;
      font-size: 10px;
    }
    .current-location {
      border: 5px solid #0000FF !important;
      box-sizing: border-box;
      width: 31px;
      height: 31px;
      z-index: 10;
    }
    .collected-treasure {
      border: 3px solid #00BFFF !important;
      box-sizing: border-box;
      width: 31px;
      height: 31px;
    }
    .special-completed {
      border: 3px solid #FFA500 !important;
      box-sizing: border-box;
      width: 31px;
      height: 31px;
    }
    .cell:hover::after {
      content: "ID: " attr(data-original-id);
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 100;
    }

    /* === Legend === */
    .legend {
      width: 280px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #2a2a2a;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    .legend-color {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <h2>Underspire Map Live (20√ó20)</h2>
  <div id="errorBox" class="error-box" style="display:none;"></div>

  <div class="upload-container">
    <div class="upload-box left">
      <h3>üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
      <div id="dropZone" class="drop-zone">
        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ JSON-—Ñ–∞–π–ª –∏–ª–∏ 
        <label for="fileInput" class="file-label">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
      </div>
    </div>
    <div class="upload-box right">
      <h3>‚úçÔ∏è –í—Å—Ç–∞–≤–∏—Ç—å JSON</h3>
      <div class="text-input-container">
        <textarea id="jsonTextarea" placeholder='{"result":{"Info":{...}}}'>{"result":{"Info":{"UnderspireData":{"Map":[[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,50741259,15,50741259],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,72351931,15,393228,50716673,17170438],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,50741260,17170437,67493893,67489794,6291627],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,50679819,15,17149962,67493898],[15,15,15,15,15,15,15,15,15,15,15,50630669,50618371,15,33914893,33902595,335880,50679895,33927176,50712582],[15,15,15,15,15,15,15,15,15,15,15,17064027,67383306,15,15,33890316,323586,15,360456,50692099],[15,15,15,15,15,15,15,15,15,15,70541357,67383300,50593794,15,50630665,67420165,50655236,17113093,33902598,67481610],[15,15,15,15,54599771,15,15,15,15,262153,67358723,17027081,33816580,274437,17063938,54526139,36974635,5636141,67493889,17158146],[15,15,67133449,151,61448,33628167,106507,16875529,54632519,20971678,17014796,17014786,237581,17002499,17063948,33853446,50593800,53477559,38142014,50716682],[15,67133451,16797706,33607689,67166210,68157595,33652748,33640450,67207177,16883717,52428983,33779724,208897,16986112,50556933,67346437,249862,15,15,33947658],[33554459,50352138,50348042,16822282,33615884,67182598,61449,67182596,33640454,67235849,139269,50479107,16969738,225294,19923099,15,15,15,15,72351902],[33554442,16396,67121154,67153928,53253,67166213,16838660,67182597,67194883,67223560,67223555,50491400,67289094,208905,50556934,15,15,15,15,15],[50331836,50331651,67117066,16814092,28675,28681,16814083,17825979,67207180,33660934,67235850,50491404,50511877,16969734,15,15,15,15,15,15],[4105,50335748,67117060,12291,50356232,50356226,45068,33607686,50491401,147461,33693700,50479105,35811367,15,15,15,15,15,15,15],[50339852,50343939,15,33570828,50352134,33583114,38850619,15,52428958,15,15,52588590,15,15,15,15,15,15,15,15],[15,4210782,15,15,15,33591308,33599490,15,15,15,15,15,15,15,15,15,15,15,15,15],[15,15,15,15,15,15,50384942,15,15,15,15,15,15,15,15,15,15,15,15,15]],"Gates":{"0":{"Node":1703,"Dir":1},"1":{"Node":1405,"Dir":1},"2":{"Node":1309,"Dir":1},"3":{"Node":1211,"Dir":0},"4":{"Node":915,"Dir":1},"5":{"Node":619,"Dir":0}},"CurrentNode":"1412","Completed":[1300,1400,1500,1401,1301,1704,1604,1504,1503,1403,1303,1404,1405,1203,1204,1304,1305,1205,1605,1705,1805,1806,9906,9706,1104,9004,1406,5407,1408,1508,1509,1409,1309,1410,1510,1610,1609,1608,1708,1310,1311,1411,1412,1603,1703,1502,1402,1302,1202,1102,1103,1600,1700,1701,9801],"Collected":[1801,1906,1706,1004],"BossRoomInfo":{"519":16166,"1103":16165,"1109":16163,"1205":16161,"1314":16164,"1319":16162,"1708":16160},"TreasureRoomInfo":{"717":16170,"811":16170,"910":16185,"1004":16194,"1016":16185,"1017":16197,"1108":16193,"1118":16192,"1612":16179,"1706":16198,"1711":16179,"1801":16194,"1906":16167}}}}}</textarea>
        <button type="button" id="submitTextBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="mapContainer"></div>

  <script>
    // ======================
    // üß© –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (JS)
    // ======================



    function _parsePosition(roomId) {
      const s = String(roomId).padStart(4, '0');
      if (s.length !== 4) return null;
      const y = parseInt(s.slice(0, 2), 10);
      const x = parseInt(s.slice(2), 10);
      if (y >= 0 && y < 20 && x >= 0 && x < 20) return [y, x];
      return null;
    }

    function _parseRoomsDict(roomDict) {
      const result = {};
      for (const [coordKey, roomId] of Object.entries(roomDict)) {
        const pos = _parsePosition(coordKey);
        if (pos) result[pos.join(',')] = roomId;
      }
      return result;
    }

    function parseMapData(dataJson) {
      try {
        const { result } = dataJson;
        const mapData = result.Info.UnderspireData.Map;
        const completedIds = result.Info.UnderspireData.Completed || [];
        const treasureInfo = result.Info.UnderspireData.TreasureRoomInfo || {};
        const bossInfo = result.Info.UnderspireData.BossRoomInfo || {};
        const gatesInfo = result.Info.UnderspireData.Gates || {};
        const collectedRaw = result.Info.UnderspireData.Collected || [];
        const current_node = result.Info.UnderspireData.CurrentNode;

        const currentPos = _parsePosition(current_node);

		const completedCoords = new Set();
		for (const id of completedIds) {
		  const num = Number(id);
		  if (!isNaN(num) && num >= 0 && num <= 1919) {
			const pos = _parsePosition(num); // _parsePosition —Å–∞–º –¥–µ–ª–∞–µ—Ç padStart
			if (pos) completedCoords.add(pos.join(','));
		  }
		}

        const treasureRooms = _parseRoomsDict(treasureInfo);
        const bossRooms = _parseRoomsDict(bossInfo);

		const collectedCoords = new Set();
		for (const id of collectedRaw) {
		  const num = Number(id);
		  if (!isNaN(num) && num >= 0 && num <= 1919) {
			const pos = _parsePosition(num);
			if (pos) collectedCoords.add(pos.join(','));
		  }
		}

        const collectedTreasureCoords = new Set(
          Object.keys(treasureRooms).filter(key => collectedCoords.has(key))
        );

        const gateCells = {};
        const gatePairs = {};
        for (const [gateId, gateData] of Object.entries(gatesInfo)) {
          const node = gateData.Node;
          const direction = gateData.Dir;
          const basePos = _parsePosition(node);
          if (!basePos) continue;

          const [y, x] = basePos;
          let cells;
          if (direction === 1) { // horizontal
            cells = [[y, x], [y, x + 1]];
          } else if (direction === 0) { // vertical
            cells = [[y, x], [y - 1, x]];
          } else continue;

          if (cells.every(([cy, cx]) => cy >= 0 && cy < 20 && cx >= 0 && cx < 20)) {
            gatePairs[gateId] = cells;
            for (const cell of cells) {
              gateCells[cell.join(',')] = gateId;
            }
          }
        }

        return {
          mapData,
          completedCoords,
          treasureRooms,
          bossRooms,
          gateCells,
          gatePairs,
          collectedTreasureCoords,
          currentPos
        };
      } catch (e) {
        throw new Error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: " + (e.message || e));
      }
    }

    // ======================
    // üé® –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã
    // ======================

    function renderMap(data) {
      const {
        mapData,
        completedCoords,
        treasureRooms,
        bossRooms,
        gateCells,
        gatePairs,
        collectedTreasureCoords,
        currentPos
      } = data;

      const rows = 20, cols = 20;

      let totalRooms = 0, remainingRooms = 0;
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          if (mapData[y][x] !== 15) {
            totalRooms++;
            if (!completedCoords.has(`${y},${x}`)) remainingRooms++;
          }
        }
      }

      const axisLabels = Array.from({length: cols}, (_, x) =>
        `<div class="axis-label">${x}</div>`
      ).join('');

      let mapRows = '';
      for (let y = 0; y < rows; y++) {
        let rowCells = `<div class="axis-label y-label">${y}</div>`;
        for (let x = 0; x < cols; x++) {
          const cellValue = mapData[y][x];
          const posKey = `${y},${x}`;
          const pos = [y, x];
          let cssClasses = ['cell'];
          let displayText = '';
          let isSpecial = false;

		  if (bossRooms[posKey] !== undefined) {
  		    cssClasses.push('boss');
		    displayText = String(bossRooms[posKey]);
		    isSpecial = true;
		  } else if (treasureRooms[posKey] !== undefined) {
		    cssClasses.push('treasure');
		    displayText = String(treasureRooms[posKey]);
		    isSpecial = true;
		  } else if (gateCells[posKey] !== undefined) {
		    const gid = gateCells[posKey];
		    cssClasses.push('gate');
		    displayText = String(Number(gid) + 1);
		    isSpecial = true;
          } else if (cellValue === 15) {
            cssClasses.push('empty');
          } else if (completedCoords.has(posKey)) {
            cssClasses.push('completed');
          } else {
            cssClasses.push('room');
          }

          if (isSpecial && completedCoords.has(posKey)) {
            cssClasses.push('special-completed');
          }

          if (currentPos && currentPos[0] === y && currentPos[1] === x) {
            cssClasses.push('current-location');
          }

          if (collectedTreasureCoords.has(posKey)) {
            //cssClasses.push('collected-treasure');
			cssClasses.push('special-completed');
          }

          const classStr = cssClasses.join(' ');
          rowCells += `<div class="${classStr}" data-original-id="${cellValue}">${displayText}</div>`;
        }
        rowCells += `<div class="axis-label y-label">${y}</div>`;
        mapRows += `<div style="display:contents;">${rowCells}</div>`;
      }

      const legendHtml = `
        <div class="legend-item"><div class="legend-color" style="border:5px solid #0000FF;"></div><span>–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#FF4500;"></div><span>–í–æ—Ä–æ—Ç–∞ (ID ‚Äî –Ω–æ–º–µ—Ä –ø–∞—Ä—ã)</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#FFD700;"></div><span>–°—Ç—Ä–∞–∂ —Å–æ–∫—Ä–æ–≤–∏—â–∞</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#32CD32;"></div><span>–ë–æ—Å—Å(–∫–ª—é—á)</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#87CEFA;"></div><span>–ü–æ—Å–µ—â–µ–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</span></div>
        <div class="legend-item"><div class="legend-color" style="background-color:#ffffff;"></div><span>–ö–æ–º–Ω–∞—Ç—ã</span></div>
        <div class="legend-item"><div class="legend-color" style="border:3px solid #FFA500;"></div><span>–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –æ—Å–æ–±—ã–µ –∫–æ–º–Ω–∞—Ç—ã</span></div>
      `;

      const stats = `
        <p>
          –ü—Ä–æ–π–¥–µ–Ω–æ: ${completedCoords.size} | 
          –°–æ–∫—Ä–æ–≤–∏—â: ${Object.keys(treasureRooms).length} (—Å–æ–±—Ä–∞–Ω–æ: ${collectedTreasureCoords.size}) | 
          –ë–æ—Å—Å–æ–≤: ${Object.keys(bossRooms).length} | 
          –í–æ—Ä–æ—Ç: ${Object.keys(gatePairs).length}
        </p>
        <p><strong>–ö–æ–º–Ω–∞—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è: ${remainingRooms} –∏–∑ ${totalRooms}</strong></p>
      `;

      return `
        ${stats}
        <div class="map-legend-container">
          <div class="map-grid-container">
            <div class="map-grid">
              <div class="axis-label"></div>
              ${axisLabels}
              <div class="axis-label"></div>
              ${mapRows}
              <div class="axis-label"></div>
              ${axisLabels}
              <div class="axis-label"></div>
            </div>
          </div>
          <div class="legend">
            ${legendHtml}
          </div>
        </div>
      `;
    }

    function showError(msg) {
      const el = document.getElementById('errorBox');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorBox').style.display = 'none';
    }

    function processData(jsonData) {
      try {
        const data = parseMapData(jsonData);
        const html = renderMap(data);
        document.getElementById('mapContainer').innerHTML = html;
        hideError();
      } catch (e) {
        showError(e.message || String(e));
      }
    }

    // ======================
    // üñ±Ô∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    // ======================

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        processData(json);
      } catch (err) {
        showError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON-—Ñ–∞–π–ª: " + (err.message || err));
      }
    });

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
    });

    dropZone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length) {
        fileInput.files = files;
        fileInput.dispatchEvent(new Event('change'));
      }
    });

    document.getElementById('submitTextBtn').addEventListener('click', () => {
      const text = document.getElementById('jsonTextarea').value.trim();
      if (!text) {
        showError('–ü–æ–ª–µ JSON –ø—É—Å—Ç–æ');
        return;
      }
      try {
        const json = JSON.parse(text);
        processData(json);
      } catch (err) {
        showError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: " + (err.message || err));
      }
    });

    // Initial demo: render empty or demo map
    window.onload = () => {
      // Try to load from URL param or localStorage? Not implemented now.
      // Just leave blank until user uploads.
    };
  </script>
</body>
</html>
