<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Underspire Map Viewer (Hybrid)</title>
<style>
/* === –û–±—â–∏–µ —Å—Ç–∏–ª–∏ === */
body {
  background: #1e1e1e;
  color: white;
  font-family: 'Segoe UI', Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  margin: 0;
}
h2 {
  margin-bottom: 5px;
  font-size: 20px;
}

/* === –û—Å–Ω–æ–≤–Ω–æ–π –º–∞–∫–µ—Ç === */
.main-layout {
  display: flex;
  gap: 20px;
  width: 100%;
  max-width: 1600px;
  margin-top: 10px;
}

/* === –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å === */
.left-panel {
  width: 300px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 20px;
}
.upload-box {
  background: #2d2d2d;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.upload-box h3 {
  margin-top: 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.upload-box h3::before {
  content: "üìÅ";
  font-size: 18px;
}
.drop-zone {
  border: 2px dashed #555;
  border-radius: 6px;
  padding: 20px;
  text-align: center;
  background: #252525;
  transition: background 0.3s;
  cursor: pointer;
  font-size: 14px;
  margin-top: 10px;
}
.drop-zone.drag-over {
  background: #333;
  border-color: #4a90e2;
}
.file-label {
  color: #4a90e2;
  text-decoration: underline;
  cursor: pointer;
}
.file-label:hover {
  color: #357abd;
}
#downloadPngBtn {
  background: #4a90e2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  padding: 10px;
  font-size: 14px;
  width: 100%;
  white-space: nowrap;
  margin-top: 10px;
}
#downloadPngBtn:hover {
  background: #357abd;
}

/* === –û–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∞ === */
.online-box {
  background: #2d2d2d;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.online-box h3 {
  margin-top: 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.online-box h3::before {
  content: "üåê";
  font-size: 18px;
}
.online-box input {
  width: 100%;
  padding: 5px;
  background: #1e1e1e;
  color: white;
  border: 1px solid #444;
  border-radius: 3px;
  margin: 5px 0;
  font-size: 13px;
}
.online-box button {
  background: #4a90e2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  padding: 8px;
  font-size: 13px;
  width: 100%;
  margin-top: 10px;
}

/* === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ === */
.stats {
  text-align: center;
  margin: 10px 0;
  font-size: 14px;
  color: #ccc;
  background: #2d2d2d;
  padding: 10px;
  border-radius: 6px;
  max-width: 1400px;
}
.stats strong {
  color: #fff;
  font-weight: bold;
}

/* === –ö–∞—Ä—Ç–∞ === */
#map-wrapper {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  overflow: hidden;
  background: #2d2d2d;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
#map-container {
  display: grid;
  gap: 0;
  position: relative;
  padding-left: 30px;   /* Y —Å–ª–µ–≤–∞ */
  padding-right: 30px;  /* Y —Å–ø—Ä–∞–≤–∞ */
  padding-bottom: 30px; /* X —Å–Ω–∏–∑—É */
  padding-top: 30px;    /* X —Å–≤–µ—Ä—Ö—É */
  transform-origin: top left;
  background: #111;
  border: 2px solid #444;
}
.tile {
  width: 32px;
  height: 32px;
  background-size: cover;
  image-rendering: pixelated;
  background-color: transparent;
  position: relative;
}
.tile-bg {
  width: 100%;
  height: 100%;
  background-size: cover;
  image-rendering: pixelated;
}
.overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  image-rendering: pixelated;
  pointer-events: none;
}
.trap-overlay { background-image: url('tiles/trap.png'); }
.oracle-overlay { background-image: url('tiles/oracle.png'); }
.secret-overlay { background-image: url('tiles/secret.png'); }
.trinket-overlay { background-image: url('tiles/trinket.png'); }
.powder-overlay { background-image: url('tiles/powder.png'); }
.cursedmine-overlay { background-image: url('tiles/cursedmine.png'); }
.treasure-overlay { background-image: url('tiles/treasure.png'); }
.entrance-overlay { background-image: url('tiles/entrance.png'); }
.merchant-overlay { background-image: url('tiles/merchant.png'); }
.boss7-overlay { background-image: url('tiles/boss7.png'); }
.treasure-guard-overlay {
  background-image: var(--guard-url);
}
.done-overlay {
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 10px;
  color: #0f0;
  font-family: Arial, sans-serif;
  text-shadow: 0 0 2px #000;
}
.empty {
  background-color: #111;
}
.y-label, .y-label-right {
  position: absolute;
  width: 30px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #888;
  pointer-events: none;
  z-index: 5;
}
.y-label {
  left: 0;
}
.y-label-right {
  right: 0;
}
.x-label, .x-label-top {
  position: absolute;
  width: 32px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #888;
  pointer-events: none;
  z-index: 5;
}
.x-label {
  bottom: 0;
}
.x-label-top {
  top: 0;
}
.keystone {
  position: absolute;
  width: 32px;
  height: 32px;
  image-rendering: pixelated;
  pointer-events: none;
  z-index: 10;
}
.tile-tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
	background: rgba(0, 0, 0, 0.85);
  color: #fff;
  padding: 4px 8px;
  border-radius: 1px;
  font-size: 12px;
  white-space: pre-line;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 20;
  max-width: 150px;
  min-width: 150px;
  word-break: pre-line;
  text-align: center;
}
.tile:hover .tile-tooltip {
  opacity: 1;
}

/* === –õ–µ–≥–µ–Ω–¥–∞ === */
.legend {
  width: 200px;
  flex-shrink: 0;
  background: #2d2d2d;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 8px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  gap: 4px;
  overflow-y: auto;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  font-size: 12px;
}
.legend-color {
  width: 24px;
  height: 24px;
  background-size: cover;
  image-rendering: pixelated;
  margin: 0;
  border: 1px solid #555;
  border-radius: 2px;
}

/* === –û—à–∏–±–∫–∏ === */
.error-box {
  background: #442222;
  padding: 15px;
  border-radius: 6px;
  margin: 10px 0;
  width: 100%;
  max-width: 1600px;
  font-family: monospace;
  white-space: pre-wrap;
  font-size: 14px;
  display: none;
}
</style>
</head>
<body>
<h2>Underspire Map Viewer (Hybrid)</h2>
<div id="errorBox" class="error-box"></div>

<div class="main-layout">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
  <div class="left-panel">
    <!-- –û–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="online-box">
      <h3>Get Map Online</h3>
      <label>NameCode:
        <input type="text" id="onlineNameCode" value="user" placeholder="Invite code">
      </label>
      <label>Password:
        <input type="password" id="onlinePassword" value="password" placeholder="Your password">
      </label>
      <button type="button" id="fetchOnlineMapBtn">Get Map</button>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <div class="upload-box">
      <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
      <div id="dropZone" class="drop-zone">
        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ JSON-—Ñ–∞–π–ª –∏–ª–∏
        <label for="fileInput" class="file-label">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
      </div>
    </div>

    <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="upload-box">
      <h3>–≠–∫—Å–ø–æ—Ä—Ç</h3>
      <button type="button" id="downloadPngBtn">–°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç—É (PNG)</button>
    </div>
  </div>

  <!-- –¶–µ–Ω—Ç—Ä: –∫–∞—Ä—Ç–∞ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
    <div id="mapStats" class="stats" style="display:none;"></div>
    <div id="map-wrapper">
      <div id="map-container"></div>
    </div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ª–µ–≥–µ–Ω–¥–∞ -->
  <div class="legend">
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/oracle.png)"></div><span>Oracle</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/secret.png)"></div><span>Secret</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/trinket.png)"></div><span>Trinket</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/powder.png)"></div><span>Powder</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/cursedmine.png)"></div><span>Cursed Mine</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/treasure.png)"></div><span>Treasure</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/entrance.png)"></div><span>Entrance</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/merchant.png)"></div><span>Merchant</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/boss1-6.png)"></div><span>Boss 1‚Äì6</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/boss7.png)"></div><span>Boss 7</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/trap.png)"></div><span>Trap</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/treasure_guard1.png)"></div><span>TG Common</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/treasure_guard2.png)"></div><span>TG Rare</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/treasure_guard3.png)"></div><span>TG Ultra-Rare</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/treasure_guard4.png)"></div><span>TG Epic</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/treasure_guard5.png)"></div><span>TG Legendary</span></div>
    <div class="legend-item"><div class="legend-color" style="background-image:url(tiles/treasure_guard6.png)"></div><span>TG Mythic</span></div>
  </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º html2canvas –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PNG -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const container = document.getElementById('map-container');
const statsEl = document.getElementById('mapStats');
const errorBox = document.getElementById('errorBox');
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const downloadPngBtn = document.getElementById('downloadPngBtn');
const fetchOnlineMapBtn = document.getElementById('fetchOnlineMapBtn');
const onlineNameCode = document.getElementById('onlineNameCode');
const onlinePassword = document.getElementById('onlinePassword');

let currentScale = 1.0;
let bossInfoMap = {};
let treasureInfoMap = {};

// === –ó–∞–≥—Ä—É–∑–∫–∞ info.json ===
async function loadDescriptions() {
  try {
    const res = await fetch('info.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    bossInfoMap = data.BossInfo || {};
    treasureInfoMap = data.TreasureInfo || {};
  } catch (err) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å info.json:', err);
    showError('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å info.json ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º–∏.');
  }
}

function showError(msg) {
  errorBox.textContent = msg;
  errorBox.style.display = 'block';
}
function hideError() {
  errorBox.style.display = 'none';
}

// === –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ===
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const json = JSON.parse(text.trim());
    await processData(json);
  } catch (err) {
    showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: " + (err.message || err));
  }
});

// Drag & Drop
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  });
});
['dragenter', 'dragover'].forEach(eventName => {
  dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
});
['dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
});
dropZone.addEventListener('drop', (e) => {
  const files = e.dataTransfer.files;
  if (files.length) {
    fileInput.files = files;
    fileInput.dispatchEvent(new Event('change'));
  }
});

// === –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ===
function updateScale() {
  const rows = container.dataset.rows || 0;
  const tileHeight = 32;
  const targetHeight = window.innerHeight * 0.7;
  const mapHeight = rows * tileHeight;
  currentScale = mapHeight ? Math.min(targetHeight / mapHeight, 3) : 1;
  container.style.transform = `scale(${currentScale})`;
  container.style.margin = `${(1 - currentScale) * tileHeight}px 0 0 ${(1 - currentScale) * tileHeight}px`;
}
window.addEventListener('resize', updateScale);

// === –û–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã ===
async function fetchOnlineMap(nameCode, password) {
  try {
    // –í—ã—á–∏—Å–ª—è–µ–º LiveEventId –∫–∞–∫ –≤ bash: UTC-7 ‚Üí —Å–º–µ—â–µ–Ω–∏–µ +7 —á–∞—Å–æ–≤
    const nowUtc = Date.now();
    const nowUtcMinus7 = nowUtc + 7 * 3600 * 1000; // UTC-7 = UTC + 7h
    const unixWeeks = Math.floor(nowUtcMinus7 / 1000 / 604800);
    const LiveEventId = unixWeeks - 2506;

    const apiUrl = "https://pcmob.parse.gemsofwar.com/call_function";

    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: get_hero_profile ‚Üí username
    const profileReq = {
      functionName: "get_hero_profile",
      NameCode: nameCode
    };

    let resp1 = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(profileReq)
    });

    if (!resp1.ok) throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: ${resp1.status} ${resp1.statusText}`);
    const profileData = await resp1.json();
    const username = profileData?.result?.ProfileData?.username;

    if (!username || username === "null") {
      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å username –ø–æ NameCode");
    }

    // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å: live_event_get_info
    const mapReq = {
      functionName: "live_event_get_info",
      username: username,
      password: password,
      LiveEventId: LiveEventId,
      LiveEventType: 17
    };

    let resp2 = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mapReq)
    });

    if (!resp2.ok) throw new Error(`–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã: ${resp2.status} ${resp2.statusText}`);
    const mapData = await resp2.json();

    // –ü–µ—Ä–µ–¥–∞—ë–º –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    await processData(mapData);

  } catch (err) {
    console.error("–û–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:", err);
    showError("–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–≥—Ä—É–∑–∫–∏: " + (err.message || err));
  }
}

// –ö–Ω–æ–ø–∫–∞ "–ö–∞—Ä—Ç–∞ –û–Ω–ª–∞–π–Ω"
fetchOnlineMapBtn.addEventListener('click', () => {
  const nameCode = onlineNameCode.value.trim();
  const password = onlinePassword.value;
  if (!nameCode || !password) {
    showError("–í–≤–µ–¥–∏—Ç–µ NameCode –∏ –ø–∞—Ä–æ–ª—å");
    return;
  }
  fetchOnlineMap(nameCode, password);
});

// === –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
async function processData(dataJson) {
  await loadDescriptions();
  try {
    const underspire = dataJson?.result?.Info?.UnderspireData;
    if (!underspire) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ result.Info.UnderspireData');

    const map = underspire.Map;
    const extraRooms = underspire.ExtraRooms || [];
    const completed = underspire.Completed || [];
    const collected = underspire.Collected || [];
    const gates = underspire.Gates || {};
    const bossRoomInfo = underspire.BossRoomInfo || {};

    if (!map || !Array.isArray(map) || map.length === 0 || !Array.isArray(map[0])) {
      throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç—ã');
    }

    const bossPositions = {};
    for (const [roomIdStr, bossId] of Object.entries(bossRoomInfo)) {
      const roomId = parseInt(roomIdStr, 10);
      if (isNaN(roomId)) continue;
      const y = Math.floor(roomId / 100);
      const x = roomId % 100;
      bossPositions[`${y},${x}`] = { id: bossId };
    }

    const specialRooms = {};
    for (const room of extraRooms) {
      if (room.TypeId != null && room.RoomId != null) {
        const xx = room.RoomId % 100;
        const yy = Math.floor(room.RoomId / 100);
        specialRooms[`${yy},${xx}`] = room.TypeId;
      }
    }

    const donePositions = new Set();
    const allDoneIds = [...completed, ...collected];
    for (const roomId of allDoneIds) {
      const xx = roomId % 100;
      const yy = Math.floor(roomId / 100);
      donePositions.add(`${yy},${xx}`);
    }

    function calculateStats(map, extraRooms, donePositions) {
      const AUTO_TYPE_IDS = new Set([0, 1, 2, 3, 4]);
      function isAutoRoomByValue(value) {
        if (value === 15) return false;
        const hex = value.toString(16).toUpperCase();
        if (hex.length < 2) return false;
        const penultimate = hex[hex.length - 2];
        return penultimate === '1' || penultimate === 'B';
      }

      const specialMap = {};
      for (const room of extraRooms) {
        if (room.TypeId != null && room.RoomId != null) {
          const xx = room.RoomId % 100;
          const yy = Math.floor(room.RoomId / 100);
          specialMap[`${yy},${xx}`] = room.TypeId;
        }
      }

      let totalRooms = 0;
      let openedAllCount = 0;
      let progressRemaining = 0;

      for (let y = 0; y < map.length; y++) {
        for (let x = 0; x < map[y].length; x++) {
          const value = map[y][x];
          if (value === 15) continue;
          totalRooms++;
          const roomKey = `${y},${x}`;
          const isDone = donePositions.has(roomKey);
          if (isDone) openedAllCount++;
          const typeId = specialMap[roomKey];
          const isAutoByType = typeId != null && AUTO_TYPE_IDS.has(typeId);
          const isAutoByValue = isAutoRoomByValue(value);
          const isAuto = isAutoByType || isAutoByValue;
          if (!isAuto && !isDone) progressRemaining++;
        }
      }
      return { totalRooms, openedAll: openedAllCount, progressRemaining };
    }

    const stats = calculateStats(map, extraRooms, donePositions);
    statsEl.innerHTML = `
      –í—Å–µ–≥–æ –∫–æ–º–Ω–∞—Ç: <b>${stats.totalRooms}</b><br>
      –û—Ç–∫—Ä—ã—Ç–æ: <b>${stats.openedAll}</b> | –û—Å—Ç–∞–ª–æ—Å—å: <b>${stats.progressRemaining}</b>
    `;
    statsEl.style.display = 'block';

    renderMap(map, specialRooms, donePositions, bossPositions);
    renderGates(map, gates);
    addCoordinateLabels(map);

    hideError();
    updateScale();
  } catch (e) {
    showError("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + (e.message || e));
  }
}

// === –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç—ã ===
const typeToClass = {0:'oracle-overlay',1:'secret-overlay',2:'trinket-overlay',3:'powder-overlay',4:'cursedmine-overlay',5:'treasure-overlay'};
const typeIdToName = {0:'Oracle',1:'Secret',2:'Trinket',3:'Powder',4:'Cursed Mine',5:'Treasure'};

function renderMap(map, specialRooms, donePositions, bossPositions) {
  const rows = map.length;
  const cols = map[0]?.length || 0;
  container.dataset.rows = rows;
  container.dataset.cols = cols;
  container.style.gridTemplateColumns = `repeat(${cols}, 32px)`;
  container.innerHTML = '';

  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const value = map[y][x];
      const tile = document.createElement('div');
      tile.className = 'tile';
      let hasContent = false;
      let tooltipTexts = [];

      if (value === 15) {
        tile.classList.add('empty');
      } else {
        const hex = value.toString(16).toUpperCase();
        const lastHexChar = hex.slice(-1);
        if (lastHexChar >= '1' && lastHexChar <= 'E') {
          const bg = document.createElement('div');
          bg.className = 'tile-bg';
          bg.style.backgroundImage = `url(tiles/${lastHexChar}.png)`;
          tile.appendChild(bg);
          hasContent = true;
        } else {
          tile.classList.add('empty');
        }

        if (hex.length >= 2) {
          const penultimate = hex[hex.length - 2];
          if (penultimate >= '2' && penultimate <= '7') {
            const guardIndex = parseInt(penultimate, 16) - 2;
            const guardNames = ['TG Common','TG Rare','TG Ultra-Rare','TG Epic','TG Legendary','TG Mythic'];
            const guardName = guardNames[guardIndex] || `TG Unknown (${penultimate})`;
            const guardNum = guardIndex + 1;
            const guard = document.createElement('div');
            guard.className = 'overlay treasure-guard-overlay';
            guard.style.backgroundImage = `url(tiles/treasure_guard${guardNum}.png)`;
            tile.appendChild(guard);
            tooltipTexts.push(guardName);
            hasContent = true;
          }
          if (penultimate === '1') {
            const entrance = document.createElement('div');
            entrance.className = 'overlay entrance-overlay';
            tile.appendChild(entrance);
            tooltipTexts.push('Entrance');
            hasContent = true;
          }
          if (penultimate === 'C') {
            const trap = document.createElement('div');
            trap.className = 'overlay trap-overlay';
            tile.appendChild(trap);
            tooltipTexts.push('Trap');
            hasContent = true;
          }
          if (penultimate === 'B') {
            const merchant = document.createElement('div');
            merchant.className = 'overlay merchant-overlay';
            tile.appendChild(merchant);
            tooltipTexts.push('Merchant');
            hasContent = true;
          }
        }
      }

      const roomKey = `${y},${x}`;
      if (bossPositions[roomKey]) {
        const { id } = bossPositions[roomKey];
        const desc = bossInfoMap[id] || `BOSS ? (ID: ${id})`;
        const parts = desc.split(/,\s*/);
        const bossLevelStr = parts[0] || '';
        let levelNum = -1;
        if (bossLevelStr.startsWith('BOSS ')) levelNum = parseInt(bossLevelStr.slice(5), 10);
        if (levelNum >= 1 && levelNum <= 6) {
          const img = document.createElement('img');
          img.src = `tiles/boss1-6.png`;
          img.className = 'overlay';
          Object.assign(img.style, {
            position: 'absolute',
            top: '0',
            left: '0',
            width: '100%',
            height: '100%',
            imageRendering: 'pixelated',
            pointerEvents: 'none'
          });
          tile.appendChild(img);
          tooltipTexts.push(...parts);
          hasContent = true;
        } else if (levelNum === 7) {
          const boss = document.createElement('div');
          boss.className = 'overlay boss7-overlay';
          tile.appendChild(boss);
          tooltipTexts.push(...parts);
          hasContent = true;
        } else {
          tooltipTexts.push(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –±–æ—Å—Å: ${desc}`);
          hasContent = true;
        }
      }

      const typeId = specialRooms[roomKey];
      if (typeId != null && typeToClass.hasOwnProperty(typeId)) {
        const overlay = document.createElement('div');
        overlay.className = `overlay ${typeToClass[typeId]}`;
        tile.appendChild(overlay);
        tooltipTexts.push(typeIdToName[typeId] || `Special ${typeId}`);
        hasContent = true;
      }

      if (donePositions.has(roomKey)) {
        const done = document.createElement('div');
        done.className = 'overlay done-overlay';
        done.textContent = '‚úì';
        tile.appendChild(done);
      }

      if (hasContent && tooltipTexts.length > 0) {
        const tooltip = document.createElement('div');
        tooltip.className = 'tile-tooltip';
        tooltip.textContent = tooltipTexts.join('\n');
        tile.appendChild(tooltip);
      }

      container.appendChild(tile);
    }
  }
}

function renderGates(map, gates) {
  const rows = map.length;
  const cols = map[0]?.length || 0;
  document.querySelectorAll('.keystone').forEach(el => el.remove());

  for (const gateId in gates) {
    if (!gates.hasOwnProperty(gateId)) continue;
    const gate = gates[gateId];
    const nodeId = gate.Node;
    const dir = gate.Dir;
    const x_node = (nodeId % 100) + 1;
    const y_node = Math.floor(nodeId / 100) + 1;

    let x1, y1, x2, y2;
    if (dir === 0) { y1 = y_node - 1; x1 = x_node; y2 = y_node; x2 = x_node; }
    else if (dir === 1) { y1 = y_node; x1 = x_node; y2 = y_node; x2 = x_node + 1; }
    else if (dir === 2) { y1 = y_node; x1 = x_node; y2 = y_node + 1; x2 = x_node; }
    else if (dir === 3) { y1 = y_node; x1 = x_node; y2 = y_node; x2 = x_node - 1; }
    else continue;

    if (y1 < 0 || y1 >= rows + 1 || x1 < 0 || x1 >= cols + 1) continue;
    if (y2 < 0 || y2 >= rows +1 || x2 < 0 || x2 >= cols + 1) continue;

    const cx1 = x1 * 32 + 16;
    const cy1 = y1 * 32 + 16;
    const cx2 = x2 * 32 + 16;
    const cy2 = y2 * 32 + 16;
    const midX = (cx1 + cx2) / 2;
    const midY = (cy1 + cy2) / 2;

    const img = document.createElement('img');
    img.src = `tiles/keystones${gateId}.png`;
    img.className = 'keystone';
    img.style.left = `${midX - 16}px`;
    img.style.top = `${midY - 16}px`;
    container.appendChild(img);
  }
}

function addCoordinateLabels(map) {
  const rows = map.length;
  const cols = map[0]?.length || 0;
  document.querySelectorAll('.y-label, .y-label-right, .x-label, .x-label-top').forEach(el => el.remove());

  for (let y = 0; y < rows; y++) {
    const labelL = document.createElement('div');
    labelL.className = 'y-label';
    labelL.style.top = `${(y + 1) * 32}px`;
    labelL.textContent = y;
    container.appendChild(labelL);

    const labelR = document.createElement('div');
    labelR.className = 'y-label-right';
    labelR.style.top = `${(y + 1) * 32}px`;
    labelR.textContent = y;
    container.appendChild(labelR);
  }

  for (let x = 0; x < cols; x++) {
    const labelT = document.createElement('div');
    labelT.className = 'x-label-top';
    labelT.style.left = `${(x + 1) * 32}px`;
    labelT.textContent = x;
    container.appendChild(labelT);

    const labelB = document.createElement('div');
    labelB.className = 'x-label';
    labelB.style.left = `${(x + 1) * 32}px`;
    labelB.textContent = x;
    container.appendChild(labelB);
  }
}

// === –°–∫–∞—á–∞—Ç—å –∫–∞–∫ PNG (—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç—É, –±–µ–∑ —Å–µ—Ä–æ–≥–æ —Ñ–æ–Ω–∞) ===
downloadPngBtn.addEventListener('click', async () => {
  try {
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ #map-container, –∞ –Ω–µ –≤–µ—Å—å wrapper
    const canvas = await html2canvas(container, {
      backgroundColor: '#111', // —Ñ–æ–Ω –∫–∞—Ä—Ç—ã
      scale: 2,
      useCORS: true,
      allowTaint: true
    });
    const link = document.createElement('a');
    link.download = 'underspire_map.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  } catch (err) {
    showError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PNG: ' + (err.message || err));
  }
});

// === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ map.json –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ===
(async () => {
  try {
    const res = await fetch('map.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    await processData(data);
  } catch (err) {
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å map.json: ' + (err.message || err));
  }
})();
</script>
</body>
</html>
